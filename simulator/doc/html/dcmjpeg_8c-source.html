<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>SIMRI3D: dcmjpeg.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>dcmjpeg.c</h1><a href="dcmjpeg_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*************************************************************************</span>
00002 <span class="comment">* $Id: dcmjpeg.c,v 1.1 2005/09/09 08:22:23 bellet Exp $</span>
00003 <span class="comment">**************************************************************************</span>
00004 <span class="comment"> This software is governed by the CeCILL  license under French law and</span>
00005 <span class="comment">  abiding by the rules of distribution of free software.  You can  use, </span>
00006 <span class="comment">  modify and/ or redistribute the software under the terms of the CeCILL</span>
00007 <span class="comment">  license as circulated by CEA, CNRS and INRIA at the following URL</span>
00008 <span class="comment">  "http://www.cecill.info". </span>
00009 <span class="comment">  </span>
00010 <span class="comment">  As a counterpart to the access to the source code and  rights to copy,</span>
00011 <span class="comment">  modify and redistribute granted by the license, users are provided only</span>
00012 <span class="comment">  with a limited warranty  and the software's author,  the holder of the</span>
00013 <span class="comment">  economic rights,  and the successive licensors  have only  limited</span>
00014 <span class="comment">  liability. </span>
00015 <span class="comment">  </span>
00016 <span class="comment">  In this respect, the user's attention is drawn to the risks associated</span>
00017 <span class="comment">  with loading,  using,  modifying and/or developing or reproducing the</span>
00018 <span class="comment">  software by the user in light of its specific status of free software,</span>
00019 <span class="comment">  that may mean  that it is complicated to manipulate,  and  that  also</span>
00020 <span class="comment">  therefore means  that it is reserved for developers  and  experienced</span>
00021 <span class="comment">  professionals having in-depth computer knowledge. Users are therefore</span>
00022 <span class="comment">  encouraged to load and test the software's suitability as regards their</span>
00023 <span class="comment">  requirements in conditions enabling the security of their systems and/or </span>
00024 <span class="comment">  data to be ensured and,  more generally, to use and operate it in the </span>
00025 <span class="comment">  same conditions as regards security. </span>
00026 <span class="comment">  </span>
00027 <span class="comment">  The fact that you are presently reading this means that you have had</span>
00028 <span class="comment">  knowledge of the CeCILL license and that you accept its terms.</span>
00029 <span class="comment">  </span>
00030 <span class="comment">  Copyright (c) CREATIS (Centre de Recherche et d'Applications en Traitement de</span>
00031 <span class="comment">  l'Image). All rights reserved. See License.txt for details.</span>
00032 <span class="comment">  </span>
00033 <span class="comment">  Version 1.0  05/09/2005</span>
00034 <span class="comment">*************************************************************************/</span>
00035 
00036 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00037 <span class="preprocessor">#include "<a class="code" href="iddcmjpeg_8h.html">iddcmjpeg.h</a>"</span>
00038 <span class="preprocessor">#include "<a class="code" href="idcommon_8h.html">idcommon.h</a>"</span>
00039    
00040    
00041 <span class="keyword">static</span> <a class="code" href="structClbJpeg.html">ClbJpeg</a>* ClbJpegAlloc(<span class="keywordtype">void</span>);
00042 <span class="keyword">static</span> <span class="keywordtype">void</span>    ClbJpegInit (<a class="code" href="structClbJpeg.html">ClbJpeg</a> *); 
00043 <span class="keyword">static</span> <span class="keywordtype">int</span>  ClbJpegDecodeDiff(<a class="code" href="structClbJpeg.html">ClbJpeg</a> *);
00044 <span class="keyword">static</span> <a class="code" href="iddcmjpeg_8h.html#a0">BOOL</a>    ClbJpegDecodeData(<a class="code" href="structClbJpeg.html">ClbJpeg</a> *);
00045 <span class="keyword">static</span> <span class="keywordtype">int</span>  ClbJpegReadBit(<a class="code" href="structClbJpeg.html">ClbJpeg</a> *);
00046 <span class="keyword">static</span> <a class="code" href="iddcmjpeg_8h.html#a0">BOOL</a>    ClbJpegReadHeader(<a class="code" href="structClbJpeg.html">ClbJpeg</a> *);
00047 <span class="keyword">static</span> <a class="code" href="iddcmjpeg_8h.html#a0">BOOL</a>    ClbJpegStart(<a class="code" href="structClbJpeg.html">ClbJpeg</a> *,FILE *);  
00048 <span class="keyword">static</span> <a class="code" href="iddcmjpeg_8h.html#a0">BOOL</a>    ClbJpegFillHuffTable(<a class="code" href="structClbJpeg.html">ClbJpeg</a> *);
00049 
00050 
00051 
00052 
<a name="l00053"></a><a class="code" href="iddcmjpeg_8h.html#a2">00053</a> <span class="keywordtype">void</span> <a class="code" href="iddcmjpeg_8h.html#a2">_IdDcmJpegFree</a>(<a class="code" href="structClbJpeg.html">ClbJpeg</a> *jpg)
00054 {
00055     free(jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>);
00056     free(jpg);
00057 }
00058 
00059 
<a name="l00060"></a><a class="code" href="iddcmjpeg_8h.html#a1">00060</a> <a class="code" href="structClbJpeg.html">ClbJpeg</a> * <a class="code" href="iddcmjpeg_8h.html#a1">_IdDcmJpegRead</a> (FILE * fp){
00061 <a class="code" href="structClbJpeg.html">ClbJpeg</a> * jpg=NULL;
00062    jpg=ClbJpegAlloc();
00063    <span class="keywordflow">if</span>(!jpg) {
00064       printf(<span class="stringliteral">"Fail to ClbJpegAlloc \n"</span>);
00065       <span class="keywordflow">return</span>(NULL);
00066    }
00067    ClbJpegInit (jpg); 
00068    <span class="keywordflow">if</span>(!ClbJpegStart(jpg, fp)) {
00069       printf(<span class="stringliteral">"Fail to ClbJpegStart \n"</span>);
00070       <span class="keywordflow">return</span> (NULL);
00071    }
00072    <span class="keywordflow">return</span> (jpg);
00073 }
00074 
00075 
00076    
00077 <span class="keyword">static</span> <span class="keywordtype">void</span> ClbJpegInit (<a class="code" href="structClbJpeg.html">ClbJpeg</a> *jpg) {
00078 <span class="keywordtype">int</span> n;
00079    <span class="keywordflow">for</span> (n=0;n&lt;256;n++)
00080    {
00081       jpg-&gt;<a class="code" href="structClbJpeg.html#o12">lHuffTable</a>[n].<a class="code" href="structHuffTable.html#o1">HufCode</a>=0;
00082       jpg-&gt;<a class="code" href="structClbJpeg.html#o12">lHuffTable</a>[n].<a class="code" href="structHuffTable.html#o0">HufSz</a>=0;
00083       jpg-&gt;<a class="code" href="structClbJpeg.html#o12">lHuffTable</a>[n].<a class="code" href="structHuffTable.html#o2">HufVal</a>=0;
00084    }
00085    jpg-&gt;<a class="code" href="structClbJpeg.html#o6">ValCurByte</a>=0;
00086    jpg-&gt;<a class="code" href="structClbJpeg.html#o7">PosCurBit</a>=10;
00087    jpg-&gt;<a class="code" href="structClbJpeg.html#o1">MarkerFound</a>=0;
00088    jpg-&gt;<a class="code" href="structClbJpeg.html#o0">RestartInterval</a>=0;
00089 }
00090 
00091 <span class="keyword">static</span> <a class="code" href="structClbJpeg.html">ClbJpeg</a> *ClbJpegAlloc(<span class="keywordtype">void</span>) {
00092 <a class="code" href="structClbJpeg.html">ClbJpeg</a> * jpg;
00093    jpg = (<a class="code" href="structClbJpeg.html">ClbJpeg</a> *)malloc(<span class="keyword">sizeof</span>(<a class="code" href="structClbJpeg.html">ClbJpeg</a>));
00094    ClbJpegInit(jpg); 
00095 <span class="keywordflow">return</span> jpg;
00096 }
00097  
00098 
00099 
00100 <span class="keyword">static</span> <a class="code" href="iddcmjpeg_8h.html#a0">BOOL</a> ClbJpegFillHuffTable(<a class="code" href="structClbJpeg.html">ClbJpeg</a> *jpg)
00101 {
00102    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> c;
00103    <span class="comment">//int testindex=0;</span>
00104    <span class="keywordtype">int</span> n=0;
00105    <span class="keywordtype">int</span> NiDHT=0;
00106    <span class="keywordtype">int</span> indexY=0;
00107    <span class="keywordtype">int</span> k, Code, Si, i;
00108 
00109    <span class="keywordflow">for</span> (c=0;c&lt;255;c++)
00110       jpg-&gt;<a class="code" href="structClbJpeg.html#o9">RawDHTstart</a>[c]=0;
00111 
00112    c=fgetc(jpg-&gt;<a class="code" href="structClbJpeg.html#o8">infp</a>);
00113 
00114 
00115    jpg-&gt;<a class="code" href="structClbJpeg.html#o3">MaxHuffSz</a>=0;
00116    jpg-&gt;<a class="code" href="structClbJpeg.html#o2">MaxHuffVal</a>=0;
00117 
00118    <span class="keywordflow">for</span> (n=1;n&lt;17;n++)
00119    {
00120       jpg-&gt;<a class="code" href="structClbJpeg.html#o5">RawDHT</a>[n]=fgetc(jpg-&gt;<a class="code" href="structClbJpeg.html#o8">infp</a>);
00121       NiDHT+=jpg-&gt;<a class="code" href="structClbJpeg.html#o5">RawDHT</a>[n];
00122       <span class="keywordflow">if</span> (jpg-&gt;<a class="code" href="structClbJpeg.html#o5">RawDHT</a>[n]!=0)
00123          jpg-&gt;<a class="code" href="structClbJpeg.html#o3">MaxHuffSz</a>=n;
00124    }
00125 
00126    <span class="keywordflow">for</span>(n=1;n&lt;16;n++)
00127    {
00128       <span class="keywordflow">if</span>(jpg-&gt;<a class="code" href="structClbJpeg.html#o5">RawDHT</a>[n]&gt;0)
00129       {
00130          jpg-&gt;<a class="code" href="structClbJpeg.html#o9">RawDHTstart</a>[n]=indexY+1;
00131          <span class="keywordflow">for</span> (i=1;i&lt;(jpg-&gt;<a class="code" href="structClbJpeg.html#o5">RawDHT</a>[n]+1);i++)
00132          {
00133             indexY+=1;
00134             c=fgetc(jpg-&gt;<a class="code" href="structClbJpeg.html#o8">infp</a>);
00135             jpg-&gt;<a class="code" href="structClbJpeg.html#o12">lHuffTable</a>[indexY].<a class="code" href="structHuffTable.html#o2">HufVal</a>=c;
00136             jpg-&gt;<a class="code" href="structClbJpeg.html#o2">MaxHuffVal</a>=c;
00137             jpg-&gt;<a class="code" href="structClbJpeg.html#o12">lHuffTable</a>[indexY].<a class="code" href="structHuffTable.html#o0">HufSz</a>=n;
00138          }
00139       }
00140    }
00141    k=1;
00142    Code=0;
00143    
00144    Si=jpg-&gt;<a class="code" href="structClbJpeg.html#o12">lHuffTable</a>[k].<a class="code" href="structHuffTable.html#o0">HufSz</a>;
00145 
00146    <span class="keywordflow">while</span>(1)
00147    {
00148       <span class="keywordflow">if</span> (k&gt;=NiDHT) <span class="keywordflow">break</span>;
00149       <span class="keywordflow">while</span>( Si==jpg-&gt;<a class="code" href="structClbJpeg.html#o12">lHuffTable</a>[k].<a class="code" href="structHuffTable.html#o0">HufSz</a>)
00150       {
00151          jpg-&gt;<a class="code" href="structClbJpeg.html#o12">lHuffTable</a>[k].<a class="code" href="structHuffTable.html#o1">HufCode</a>=Code;
00152          Code+=1;
00153          k+=1;
00154       }
00155       <span class="keywordflow">if</span> (k&lt;NiDHT)
00156       {
00157          <span class="keywordflow">while</span> (jpg-&gt;<a class="code" href="structClbJpeg.html#o12">lHuffTable</a>[k].<a class="code" href="structHuffTable.html#o0">HufSz</a>&gt;Si)
00158          {
00159             Code=Code&lt;&lt;1;
00160             Si+=1;
00161          }
00162       }
00163    }
00164 
00165    <span class="keywordflow">return</span> 1;
00166 }
00167 
00168    
00169 
00170 <span class="keyword">static</span> <a class="code" href="iddcmjpeg_8h.html#a0">BOOL</a> ClbJpegStart(<a class="code" href="structClbJpeg.html">ClbJpeg</a> *jpg, FILE *inputfp)
00171 {
00172    jpg-&gt;<a class="code" href="structClbJpeg.html#o8">infp</a>=inputfp;
00173    <span class="keywordflow">if</span> (!ClbJpegReadHeader(jpg)) {
00174       printf(<span class="stringliteral">"Fail to ClbJpegReadHeader\n"</span>);
00175       <span class="keywordflow">return</span> 0;
00176    }
00177    <span class="comment">//printf("sortie ClbJpegReadHeader\n");</span>
00178    <span class="keywordflow">if</span> (!ClbJpegDecodeData(jpg)) {
00179       printf(<span class="stringliteral">"Fail to ClbJpegDecodeData\n"</span>);
00180       <span class="keywordflow">return</span> 0;
00181    }  
00182    <span class="comment">//printf("sortie ClbJpegDecodeData\n");</span>
00183    <span class="keywordflow">return</span> 1;
00184 }
00185 
00186 <span class="keyword">static</span> <a class="code" href="iddcmjpeg_8h.html#a0">BOOL</a> ClbJpegReadHeader(<a class="code" href="structClbJpeg.html">ClbJpeg</a> *jpg)
00187 {
00188    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> gr;
00189    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> el;
00190    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> l2;
00191    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> l1;
00192    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> sztag;
00193    <span class="keywordtype">long</span> ouca=0;
00194    <a class="code" href="iddcmjpeg_8h.html#a0">BOOL</a> HeaderEnd=0;
00195    <a class="code" href="iddcmjpeg_8h.html#a0">BOOL</a> isLossLess=0;
00196    
00197    <span class="keywordtype">int</span> tp;
00198 
00199    gr=fgetc(jpg-&gt;<a class="code" href="structClbJpeg.html#o8">infp</a>);  <span class="comment">//FF</span>
00200    el=fgetc(jpg-&gt;<a class="code" href="structClbJpeg.html#o8">infp</a>);  <span class="comment">//D8</span>
00201 
00202    <span class="keywordflow">while</span>(!HeaderEnd)
00203    {
00204       gr=fgetc(jpg-&gt;<a class="code" href="structClbJpeg.html#o8">infp</a>);  
00205       <span class="keywordflow">if</span>(gr!=0xFF) {
00206          printf(<span class="stringliteral">"gr!=0xFF (=%02x)\n"</span>,gr);
00207          <span class="keywordflow">return</span> 0;
00208       }
00209       el=fgetc(jpg-&gt;<a class="code" href="structClbJpeg.html#o8">infp</a>);
00210 
00211       <span class="keywordflow">if</span> ( (el==0xFF) || (el==0x01) || (el==0xD8) ||(el==0xD9) ||( (el&gt;=0xD0) &amp;&amp; (el&lt;=0xD7) ))
00212          ;
00213       <span class="keywordflow">else</span>
00214       {
00215          l1=fgetc(jpg-&gt;<a class="code" href="structClbJpeg.html#o8">infp</a>);
00216          l2=fgetc(jpg-&gt;<a class="code" href="structClbJpeg.html#o8">infp</a>);
00217          sztag=(l1*256)+l2-2; <span class="comment">//tag lengh</span>
00218          ouca=ftell(jpg-&gt;<a class="code" href="structClbJpeg.html#o8">infp</a>);
00219 
00220          <span class="keywordflow">if</span> (el==0xC3)
00221          {
00222             jpg-&gt;<a class="code" href="structClbJpeg.html#o10">lSof</a>.<a class="code" href="structSof.html#o0">precision</a>=fgetc(jpg-&gt;<a class="code" href="structClbJpeg.html#o8">infp</a>);
00223 
00224             l1=fgetc(jpg-&gt;<a class="code" href="structClbJpeg.html#o8">infp</a>);
00225             l2=fgetc(jpg-&gt;<a class="code" href="structClbJpeg.html#o8">infp</a>);
00226             jpg-&gt;<a class="code" href="structClbJpeg.html#o10">lSof</a>.<a class="code" href="structSof.html#o1">Himg</a>=(l1*256)+l2;
00227 
00228             l1=fgetc(jpg-&gt;<a class="code" href="structClbJpeg.html#o8">infp</a>);
00229             l2=fgetc(jpg-&gt;<a class="code" href="structClbJpeg.html#o8">infp</a>);
00230             jpg-&gt;<a class="code" href="structClbJpeg.html#o10">lSof</a>.<a class="code" href="structSof.html#o2">Wimg</a>=(l1*256)+l2;
00231 
00232             jpg-&gt;<a class="code" href="structClbJpeg.html#o10">lSof</a>.<a class="code" href="structSof.html#o3">NbComponent</a>=fgetc(jpg-&gt;<a class="code" href="structClbJpeg.html#o8">infp</a>);
00233 
00234             jpg-&gt;<a class="code" href="structClbJpeg.html#o10">lSof</a>.<a class="code" href="structSof.html#o4">SofTabPos</a>=ftell(jpg-&gt;<a class="code" href="structClbJpeg.html#o8">infp</a>);
00235 
00236             isLossLess=<a class="code" href="idarg_8h.html#a4">TRUE</a>;
00237          }
00238 
00239          <span class="keywordflow">if</span> (el==0xC4)
00240          {
00241             ClbJpegFillHuffTable(jpg);
00242          }
00243          <span class="keywordflow">if</span> (el==0xDA)
00244          {
00245             jpg-&gt;<a class="code" href="structClbJpeg.html#o11">lSos</a>.<a class="code" href="structSos.html#o0">CompCount</a>=fgetc(jpg-&gt;<a class="code" href="structClbJpeg.html#o8">infp</a>);
00246             <span class="keywordflow">for</span> (tp=0;tp&lt;jpg-&gt;<a class="code" href="structClbJpeg.html#o11">lSos</a>.<a class="code" href="structSos.html#o0">CompCount</a>;tp++)
00247             {
00248                jpg-&gt;<a class="code" href="structClbJpeg.html#o11">lSos</a>.<a class="code" href="structSos.html#o1">CompId</a>=fgetc(jpg-&gt;<a class="code" href="structClbJpeg.html#o8">infp</a>);
00249                jpg-&gt;<a class="code" href="structClbJpeg.html#o11">lSos</a>.<a class="code" href="structSos.html#o2">CompDc</a>=fgetc(jpg-&gt;<a class="code" href="structClbJpeg.html#o8">infp</a>);
00250             }
00251             jpg-&gt;<a class="code" href="structClbJpeg.html#o11">lSos</a>.<a class="code" href="structSos.html#o3">SpectralSelStart</a>=fgetc(jpg-&gt;<a class="code" href="structClbJpeg.html#o8">infp</a>);
00252             jpg-&gt;<a class="code" href="structClbJpeg.html#o11">lSos</a>.<a class="code" href="structSos.html#o4">SpectralSelEnd</a>=fgetc(jpg-&gt;<a class="code" href="structClbJpeg.html#o8">infp</a>);
00253             jpg-&gt;<a class="code" href="structClbJpeg.html#o11">lSos</a>.<a class="code" href="structSos.html#o5">SuccessiveAp</a>=fgetc(jpg-&gt;<a class="code" href="structClbJpeg.html#o8">infp</a>);
00254             jpg-&gt;<a class="code" href="structClbJpeg.html#o11">lSos</a>.<a class="code" href="structSos.html#o6">Sospttrans</a>=(jpg-&gt;<a class="code" href="structClbJpeg.html#o11">lSos</a>.<a class="code" href="structSos.html#o5">SuccessiveAp</a> &amp; 16);
00255             HeaderEnd=1;
00256          }
00257          <span class="keywordflow">if</span> (el==0xDD)
00258          {
00259             l1=fgetc(jpg-&gt;<a class="code" href="structClbJpeg.html#o8">infp</a>);
00260             l2=fgetc(jpg-&gt;<a class="code" href="structClbJpeg.html#o8">infp</a>);
00261             jpg-&gt;<a class="code" href="structClbJpeg.html#o0">RestartInterval</a>=(l1*256)+l2;
00262          }
00263 
00264          fseek(jpg-&gt;<a class="code" href="structClbJpeg.html#o8">infp</a>,(ouca+sztag),0);
00265       }
00266    }
00267 
00268    <span class="keywordflow">if</span> (!isLossLess) {
00269       printf(<span class="stringliteral">"NOT isLossLess\n"</span>);
00270       <span class="keywordflow">return</span> 0;
00271    }
00272    <span class="keywordflow">return</span> 1;
00273 
00274 }
00275 
00276 <span class="keyword">static</span> <span class="keywordtype">int</span> ClbJpegReadBit(<a class="code" href="structClbJpeg.html">ClbJpeg</a> *jpg)
00277 {
00278    <span class="keywordtype">int</span> r=0;
00279    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> c;
00280    <span class="keywordflow">if</span>(jpg-&gt;<a class="code" href="structClbJpeg.html#o7">PosCurBit</a>&gt;8) <span class="comment">// need lire octet suivant</span>
00281    {
00282       jpg-&gt;<a class="code" href="structClbJpeg.html#o6">ValCurByte</a>=fgetc(jpg-&gt;<a class="code" href="structClbJpeg.html#o8">infp</a>);
00283       <span class="keywordflow">if</span> (jpg-&gt;<a class="code" href="structClbJpeg.html#o6">ValCurByte</a>==0xFF)
00284       {
00285          c=fgetc(jpg-&gt;<a class="code" href="structClbJpeg.html#o8">infp</a>);<span class="comment">// est 00 ou restart marker: a skiper</span>
00286          <span class="keywordflow">if</span> (c!=0)
00287          {
00288             jpg-&gt;<a class="code" href="structClbJpeg.html#o6">ValCurByte</a>=fgetc(jpg-&gt;<a class="code" href="structClbJpeg.html#o8">infp</a>);
00289             jpg-&gt;<a class="code" href="structClbJpeg.html#o7">PosCurBit</a>=1;
00290             jpg-&gt;<a class="code" href="structClbJpeg.html#o1">MarkerFound</a>=1;
00291             <span class="keywordflow">return</span> 0; 
00292          }
00293       }
00294       jpg-&gt;<a class="code" href="structClbJpeg.html#o7">PosCurBit</a>=2;
00295       <span class="keywordflow">return</span> (jpg-&gt;<a class="code" href="structClbJpeg.html#o6">ValCurByte</a>&gt;&gt;7);
00296    }
00297    <span class="keywordflow">else</span>
00298    {
00299       r=(1&amp;(jpg-&gt;<a class="code" href="structClbJpeg.html#o6">ValCurByte</a>&gt;&gt;(8-jpg-&gt;<a class="code" href="structClbJpeg.html#o7">PosCurBit</a>)));
00300       jpg-&gt;<a class="code" href="structClbJpeg.html#o7">PosCurBit</a>+=1;
00301       <span class="keywordflow">return</span> r;
00302    }
00303 }
00304 
00305 
00306 <span class="keyword">static</span> <a class="code" href="iddcmjpeg_8h.html#a0">BOOL</a> ClbJpegDecodeData(<a class="code" href="structClbJpeg.html">ClbJpeg</a> *jpg)
00307 {
00308    <span class="keywordtype">int</span> iX,iY;
00309    <span class="keywordtype">int</span> lbInc=0;
00310    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> mask; 
00311      
00312    <span class="keywordtype">int</span> lPredicted=(1&lt;&lt;(jpg-&gt;<a class="code" href="structClbJpeg.html#o10">lSof</a>.<a class="code" href="structSof.html#o0">precision</a>-1-jpg-&gt;<a class="code" href="structClbJpeg.html#o11">lSos</a>.<a class="code" href="structSos.html#o6">Sospttrans</a>));
00313 
00314    jpg-&gt;<a class="code" href="structClbJpeg.html#o6">ValCurByte</a>=jpg-&gt;<a class="code" href="structClbJpeg.html#o11">lSos</a>.<a class="code" href="structSos.html#o5">SuccessiveAp</a>;
00315    jpg-&gt;<a class="code" href="structClbJpeg.html#o7">PosCurBit</a>=9;
00316    
00317    <span class="keywordflow">if</span> (jpg-&gt;<a class="code" href="structClbJpeg.html#o10">lSof</a>.<a class="code" href="structSof.html#o0">precision</a>==8)
00318       mask=0xFF;
00319    <span class="keywordflow">if</span> (jpg-&gt;<a class="code" href="structClbJpeg.html#o10">lSof</a>.<a class="code" href="structSof.html#o0">precision</a>==12)
00320       mask=0xFFF;
00321    <span class="keywordflow">if</span> (jpg-&gt;<a class="code" href="structClbJpeg.html#o10">lSof</a>.<a class="code" href="structSof.html#o0">precision</a>==16)
00322       mask=0xFFFF;
00323 
00324     jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>=(<span class="keywordtype">int</span>*)malloc(jpg-&gt;<a class="code" href="structClbJpeg.html#o10">lSof</a>.<a class="code" href="structSof.html#o1">Himg</a>*jpg-&gt;<a class="code" href="structClbJpeg.html#o10">lSof</a>.<a class="code" href="structSof.html#o2">Wimg</a>*<span class="keyword">sizeof</span>(*jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>));
00325    memset( jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>,0,(jpg-&gt;<a class="code" href="structClbJpeg.html#o10">lSof</a>.<a class="code" href="structSof.html#o1">Himg</a>*jpg-&gt;<a class="code" href="structClbJpeg.html#o10">lSof</a>.<a class="code" href="structSof.html#o2">Wimg</a>*<span class="keyword">sizeof</span>(*jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>)));
00326 
00327    <span class="keywordflow">if</span> (!jpg-&gt;<a class="code" href="structClbJpeg.html#o0">RestartInterval</a>)
00328    {
00329       <span class="keywordflow">for</span>(iX=0;iX&lt;jpg-&gt;<a class="code" href="structClbJpeg.html#o10">lSof</a>.<a class="code" href="structSof.html#o2">Wimg</a>;iX++) <span class="comment">// lit première ligne</span>
00330       {
00331          lbInc+=1;
00332          <span class="keywordflow">if</span> (lbInc&gt;1)
00333             lPredicted= jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc-1];
00334           jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc]=lPredicted+ClbJpegDecodeDiff(jpg);
00335 
00336          <span class="keywordflow">if</span> (  jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc] &gt; ((1&lt;&lt;(jpg-&gt;<a class="code" href="structClbJpeg.html#o10">lSof</a>.<a class="code" href="structSof.html#o0">precision</a>))-1) )
00337              jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc]= jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc]&amp;mask;
00338          <span class="keywordflow">if</span> ( jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc]&lt;0) 
00339              jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc]= jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc]&amp;mask;
00340       }
00341 
00342       <span class="keywordflow">for</span> (iY=1;iY&lt;jpg-&gt;<a class="code" href="structClbJpeg.html#o10">lSof</a>.<a class="code" href="structSof.html#o1">Himg</a>;iY++) <span class="comment">//lit la suite</span>
00343       {
00344          lbInc+=1;
00345          <span class="keywordflow">if</span> (lbInc&gt;(jpg-&gt;<a class="code" href="structClbJpeg.html#o10">lSof</a>.<a class="code" href="structSof.html#o1">Himg</a>*jpg-&gt;<a class="code" href="structClbJpeg.html#o10">lSof</a>.<a class="code" href="structSof.html#o2">Wimg</a>-1)) <span class="keywordflow">break</span>;
00346          lPredicted= jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc-jpg-&gt;<a class="code" href="structClbJpeg.html#o10">lSof</a>.<a class="code" href="structSof.html#o2">Wimg</a>]; <span class="comment">// se base % premier é ligne d'avant</span>
00347           jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc]=lPredicted+ClbJpegDecodeDiff(jpg);
00348 
00349          <span class="keywordflow">if</span> (  jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc] &gt; ((1&lt;&lt;(jpg-&gt;<a class="code" href="structClbJpeg.html#o10">lSof</a>.<a class="code" href="structSof.html#o0">precision</a>))-1) ) 
00350              jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc]= jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc]&amp;mask;
00351          <span class="keywordflow">if</span> ( jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc]&lt;0) 
00352              jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc]= jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc]&amp;mask;
00353 
00354          <span class="keywordflow">for</span>(iX=1;iX&lt;jpg-&gt;<a class="code" href="structClbJpeg.html#o10">lSof</a>.<a class="code" href="structSof.html#o2">Wimg</a>;iX++)
00355          {
00356             lbInc+=1;
00357             <span class="keywordflow">if</span> (lbInc&gt;(jpg-&gt;<a class="code" href="structClbJpeg.html#o10">lSof</a>.<a class="code" href="structSof.html#o1">Himg</a>*jpg-&gt;<a class="code" href="structClbJpeg.html#o10">lSof</a>.<a class="code" href="structSof.html#o2">Wimg</a>-1)) <span class="keywordflow">break</span>;
00358             <span class="keywordflow">if</span> (jpg-&gt;<a class="code" href="structClbJpeg.html#o11">lSos</a>.<a class="code" href="structSos.html#o3">SpectralSelStart</a>==7) <span class="comment">// si spectral</span>
00359                lPredicted=( jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc-1]+ jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc-jpg-&gt;<a class="code" href="structClbJpeg.html#o10">lSof</a>.<a class="code" href="structSof.html#o2">Wimg</a>])&gt;&gt;1;
00360             <span class="keywordflow">else</span>
00361                lPredicted= jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc-1];     <span class="comment">// se base%pixel juste avant</span>
00362              jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc]=lPredicted+ClbJpegDecodeDiff(jpg);
00363 
00364             <span class="keywordflow">if</span> (  jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc] &gt; ((1&lt;&lt;(jpg-&gt;<a class="code" href="structClbJpeg.html#o10">lSof</a>.<a class="code" href="structSof.html#o0">precision</a>))-1) ) 
00365                 jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc]= jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc]&amp;mask;
00366             <span class="keywordflow">if</span> ( jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc]&lt;0) 
00367                 jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc]= jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc]&amp;mask;
00368 
00369          }
00370       }
00371    }
00372    <span class="keywordflow">else</span> <span class="comment">// il y a un define interval</span>
00373    {
00374       <span class="keywordflow">while</span>(1)
00375       {
00376          jpg-&gt;<a class="code" href="structClbJpeg.html#o1">MarkerFound</a>=0;
00377          lPredicted=(1&lt;&lt;(jpg-&gt;<a class="code" href="structClbJpeg.html#o10">lSof</a>.<a class="code" href="structSof.html#o0">precision</a> - 1 - jpg-&gt;<a class="code" href="structClbJpeg.html#o11">lSos</a>.<a class="code" href="structSos.html#o6">Sospttrans</a>));
00378          <span class="keywordflow">for</span> (iY=0;iY&lt;jpg-&gt;<a class="code" href="structClbJpeg.html#o0">RestartInterval</a>;iY++) 
00379          {
00380              jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc]=lPredicted+ClbJpegDecodeDiff(jpg);
00381 
00382             <span class="keywordflow">if</span> (  jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc] &gt; ((1&lt;&lt;(jpg-&gt;<a class="code" href="structClbJpeg.html#o10">lSof</a>.<a class="code" href="structSof.html#o0">precision</a>))-1) ) 
00383                 jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc]= jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc]&amp;mask;
00384             <span class="keywordflow">if</span> ( jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc]&lt;0) 
00385                 jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc]= jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc]&amp;mask;
00386 
00387             lbInc+=1;
00388             <span class="keywordflow">if</span> (lbInc&gt;(jpg-&gt;<a class="code" href="structClbJpeg.html#o10">lSof</a>.<a class="code" href="structSof.html#o1">Himg</a>*jpg-&gt;<a class="code" href="structClbJpeg.html#o10">lSof</a>.<a class="code" href="structSof.html#o2">Wimg</a>-1)) <span class="keywordflow">return</span> 1;
00389 
00390             <span class="keywordflow">if</span> (jpg-&gt;<a class="code" href="structClbJpeg.html#o11">lSos</a>.<a class="code" href="structSos.html#o3">SpectralSelStart</a>==7) <span class="comment">// si spectral</span>
00391                lPredicted=( jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc-1]+ jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc-jpg-&gt;<a class="code" href="structClbJpeg.html#o10">lSof</a>.<a class="code" href="structSof.html#o2">Wimg</a>])&gt;&gt;1;
00392             <span class="keywordflow">else</span>
00393                lPredicted= jpg-&gt;<a class="code" href="structClbJpeg.html#o4">DataImg</a>[lbInc-1];
00394          }
00395          <span class="keywordflow">while</span> (!jpg-&gt;<a class="code" href="structClbJpeg.html#o1">MarkerFound</a>)
00396          {
00397             ClbJpegReadBit(jpg); <span class="comment">// skip bits restant avant restart marker</span>
00398          }
00399       }
00400    }
00401    <span class="keywordflow">return</span> 1;
00402 }
00403 
00404 <span class="keyword">static</span> <span class="keywordtype">int</span> ClbJpegDecodeDiff(<a class="code" href="structClbJpeg.html">ClbJpeg</a> *jpg)
00405 {
00406    <span class="keywordtype">int</span> lInput;
00407    <span class="keywordtype">int</span> lInputBits;
00408    <span class="keywordtype">int</span> lHufVal;
00409    <span class="keywordtype">int</span> lDiff;
00410    <span class="keywordtype">int</span> lI;
00411    <span class="keywordtype">int</span> resultat;
00412    lHufVal = 666;
00413    lInput = 0;
00414    lInputBits = 0;
00415    
00416    
00417    <span class="keywordflow">while</span> (1)
00418    {
00419       lInputBits+=1;
00420       lInput=(lInput&lt;&lt;1)+ClbJpegReadBit(jpg);
00421       <span class="keywordflow">if</span> (jpg-&gt;<a class="code" href="structClbJpeg.html#o5">RawDHT</a>[lInputBits]!=0)
00422       {
00423          <span class="keywordflow">for</span>(lI=jpg-&gt;<a class="code" href="structClbJpeg.html#o9">RawDHTstart</a>[lInputBits];lI&lt;(jpg-&gt;<a class="code" href="structClbJpeg.html#o9">RawDHTstart</a>[lInputBits]+jpg-&gt;<a class="code" href="structClbJpeg.html#o5">RawDHT</a>[lInputBits]);lI++)
00424          {
00425             <span class="keywordflow">if</span> (lInput==jpg-&gt;<a class="code" href="structClbJpeg.html#o12">lHuffTable</a>[lI].<a class="code" href="structHuffTable.html#o1">HufCode</a>)
00426                lHufVal=jpg-&gt;<a class="code" href="structClbJpeg.html#o12">lHuffTable</a>[lI].<a class="code" href="structHuffTable.html#o2">HufVal</a>;
00427          }
00428       }
00429       <span class="keywordflow">if</span> (lInputBits&gt;=jpg-&gt;<a class="code" href="structClbJpeg.html#o3">MaxHuffSz</a>)
00430          lHufVal=jpg-&gt;<a class="code" href="structClbJpeg.html#o2">MaxHuffVal</a>;
00431       <span class="keywordflow">if</span> (lHufVal&lt;255) <span class="keywordflow">break</span>;
00432    }
00433    <span class="keywordflow">if</span> (lHufVal==0) resultat= 0;
00434 
00435    <span class="keywordflow">if</span> ( (lHufVal&gt;0) &amp;&amp; (lHufVal&lt;16))
00436    {
00437       lDiff=0;
00438       <span class="keywordflow">if</span>( ClbJpegReadBit(jpg)==1)
00439       {
00440          <span class="keywordflow">for</span> (lI=1;lI&lt;lHufVal;lI++)
00441          {
00442             lDiff=(lDiff&lt;&lt;1)+ClbJpegReadBit(jpg);
00443          }
00444 
00445          resultat= (lDiff+(1&lt;&lt;(lHufVal-1)));
00446       }
00447       <span class="keywordflow">else</span>
00448       {
00449          <span class="keywordflow">for</span> (lI=1;lI&lt;lHufVal;lI++)
00450             lDiff=(lDiff&lt;&lt;1)+1-ClbJpegReadBit(jpg);
00451          resultat= -(lDiff+(1&lt;&lt;(lHufVal-1)));
00452       }
00453    }
00454 
00455    <span class="keywordflow">return</span> resultat;
00456    
00457 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Wed Dec 20 14:28:13 2006 for SIMRI3D by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
