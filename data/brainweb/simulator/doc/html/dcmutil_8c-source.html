<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>SIMRI3D: dcmutil.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>dcmutil.c</h1><a href="dcmutil_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*************************************************************************</span>
00002 <span class="comment">* $Id: dcmutil.c,v 1.4 2005/09/26 10:20:08 bellet Exp $</span>
00003 <span class="comment">**************************************************************************</span>
00004 <span class="comment"> This software is governed by the CeCILL  license under French law and</span>
00005 <span class="comment">  abiding by the rules of distribution of free software.  You can  use, </span>
00006 <span class="comment">  modify and/ or redistribute the software under the terms of the CeCILL</span>
00007 <span class="comment">  license as circulated by CEA, CNRS and INRIA at the following URL</span>
00008 <span class="comment">  "http://www.cecill.info". </span>
00009 <span class="comment">  </span>
00010 <span class="comment">  As a counterpart to the access to the source code and  rights to copy,</span>
00011 <span class="comment">  modify and redistribute granted by the license, users are provided only</span>
00012 <span class="comment">  with a limited warranty  and the software's author,  the holder of the</span>
00013 <span class="comment">  economic rights,  and the successive licensors  have only  limited</span>
00014 <span class="comment">  liability. </span>
00015 <span class="comment">  </span>
00016 <span class="comment">  In this respect, the user's attention is drawn to the risks associated</span>
00017 <span class="comment">  with loading,  using,  modifying and/or developing or reproducing the</span>
00018 <span class="comment">  software by the user in light of its specific status of free software,</span>
00019 <span class="comment">  that may mean  that it is complicated to manipulate,  and  that  also</span>
00020 <span class="comment">  therefore means  that it is reserved for developers  and  experienced</span>
00021 <span class="comment">  professionals having in-depth computer knowledge. Users are therefore</span>
00022 <span class="comment">  encouraged to load and test the software's suitability as regards their</span>
00023 <span class="comment">  requirements in conditions enabling the security of their systems and/or </span>
00024 <span class="comment">  data to be ensured and,  more generally, to use and operate it in the </span>
00025 <span class="comment">  same conditions as regards security. </span>
00026 <span class="comment">  </span>
00027 <span class="comment">  The fact that you are presently reading this means that you have had</span>
00028 <span class="comment">  knowledge of the CeCILL license and that you accept its terms.</span>
00029 <span class="comment">  </span>
00030 <span class="comment">  Copyright (c) CREATIS (Centre de Recherche et d'Applications en Traitement de</span>
00031 <span class="comment">  l'Image). All rights reserved. See License.txt for details.</span>
00032 <span class="comment">  </span>
00033 <span class="comment">  Version 1.0  05/09/2005</span>
00034 <span class="comment">*************************************************************************/</span>
00035 
00036 <span class="preprocessor">#include "<a class="code" href="idio_8h.html">idio.h</a>"</span>
00037 <span class="preprocessor">#include "<a class="code" href="iddicom_8h.html">iddicom.h</a>"</span>
00038 <span class="preprocessor">#include "<a class="code" href="iddcm-restricted_8h.html">iddcm-restricted.h</a>"</span>
00039 <span class="preprocessor">#include "<a class="code" href="iderr_8h.html">iderr.h</a>"</span>
00040 <span class="preprocessor">#include &lt;string.h&gt;</span>
00041 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00042 
00043 <span class="preprocessor">#ifdef _MSC_VER</span>
00044 <span class="preprocessor"></span><span class="preprocessor">#include &lt;winsock.h&gt;</span>    <span class="comment">// Pour ntohs - BigEndianeries -</span>
00045 <span class="preprocessor">#else</span>
00046 <span class="preprocessor"></span><span class="preprocessor">#include &lt;netinet/in.h&gt;</span>    <span class="comment">// Pour ntohs - BigEndianeries -</span>
00047 <span class="preprocessor">#endif</span>
00048 <span class="preprocessor"></span>
00049 <span class="preprocessor">#include "<a class="code" href="idliste_8h.html">idliste.h</a>"</span>
00050 
00051 <span class="keywordtype">char</span> * <a class="code" href="str_8c.html#a14">_IdStrShowTransfertSyntax</a> (<span class="keywordtype">char</span> * codeTransfSynt);
00052 
<a name="l00053"></a><a class="code" href="dcmutil_8c.html#a0">00053</a> <span class="preprocessor">#define LGR_ENTETE_A_LIRE 256          // on ne lit plus que le debut</span>
00054 <span class="preprocessor"></span> 
00055 <span class="preprocessor">#define DEBUG 0</span>
00056 <span class="preprocessor"></span>
00057 
00058 <span class="comment">// ON NE DECORTIQUE PLUS LES SQ (trop long, trop dangereux, inutile)</span>
00059 
00060 <span class="keyword">static</span> <span class="keywordtype">char</span> * var_itoa(<span class="keywordtype">void</span> * , <span class="keywordtype">int</span> );
00061 <span class="keyword">static</span> <span class="keywordtype">char</span> * _cleanString(<span class="keywordtype">char</span> *);
00062 
00063 <span class="keyword">static</span> uint32_t   _IdDcmRecupLgr(<a class="code" href="structID__DCM__HDR.html">ID_DCM_HDR</a> *, <span class="keywordtype">int</span>, <span class="keywordtype">int</span>*, <span class="keywordtype">int</span> *);
00064 <span class="keyword">static</span> <span class="keywordtype">int</span>  _IdDcmCheckSwap(<a class="code" href="structID__DCM__HDR.html">ID_DCM_HDR</a> *);
00065 <span class="keyword">static</span> <span class="keywordtype">int</span>  _IdDcmLireEtStockerElement(<a class="code" href="structID__DCM__HDR.html">ID_DCM_HDR</a> *, <span class="keywordtype">char</span> **, <span class="keywordtype">int</span>,
00066              <span class="keywordtype">int</span>, <span class="keywordtype">char</span> *, <span class="keywordtype">int</span>);
00067     <span class="keywordtype">char</span> ** <a class="code" href="dcmutil_8c.html#a11">_IdDcmInquireImageInfoXXX</a> (<a class="code" href="structID__DCM__HDR.html">ID_DCM_HDR</a> *, <span class="keywordtype">char</span> **);    
00068 
00069 <span class="keyword">static</span> <span class="keywordtype">void</span> _setAcrLibido(<a class="code" href="structID__DCM__HDR.html">ID_DCM_HDR</a> *);
00070 
00071 <span class="comment">// -----------------------------------------------------------------</span>
00072 
<a name="l00079"></a><a class="code" href="iddcm_8h.html#a3">00079</a> <a class="code" href="structID__DCM__HDR.html">ID_DCM_HDR</a> * <a class="code" href="dcmutil_8c.html#a13">IdDcmHdrAlloc</a> () {
00080    <a class="code" href="structID__DCM__HDR.html">ID_DCM_HDR</a> *e = (<a class="code" href="structID__DCM__HDR.html">ID_DCM_HDR</a> *) calloc (1, <span class="keyword">sizeof</span>(<a class="code" href="structID__DCM__HDR.html">ID_DCM_HDR</a>));
00081    <span class="keywordflow">if</span> (!e) <span class="keywordflow">return</span> e;
00082    
00083    e-&gt;<a class="code" href="structID__DCM__HDR.html#o16">deb</a> = (<span class="keywordtype">char</span> *) malloc(<a class="code" href="dcmutil_8c.html#a0">LGR_ENTETE_A_LIRE</a>);
00084    <span class="keywordflow">if</span> (!e-&gt;<a class="code" href="structID__DCM__HDR.html#o16">deb</a>) { 
00085       free(e);
00086       printf(<span class="stringliteral">"Echec alloc ID_DCM_HDR\n"</span>);
00087    }
00088    
00089    e-&gt;<a class="code" href="structID__DCM__HDR.html#o19">plist</a> = <a class="code" href="idliste_8h.html#a37">IdLstAlloc</a>();
00090 
00091    <span class="keywordflow">if</span> (!e-&gt;<a class="code" href="structID__DCM__HDR.html#o19">plist</a>) {
00092       free(e-&gt;<a class="code" href="structID__DCM__HDR.html#o16">deb</a>);
00093       free(e);
00094       printf(<span class="stringliteral">"Echec alloc ID_DCM_HDR-&gt;deb\n"</span>);
00095       <span class="keywordflow">return</span> (ID_DCM_HDR *)NULL;
00096    }  
00097    <span class="keywordflow">return</span>(e);
00098 }
00099 
00100 <span class="comment">// ------------------------------------------------------------------</span>
<a name="l00108"></a><a class="code" href="iddcm_8h.html#a4">00108</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="iddcm_8h.html#a4">IdDcmHdrFree</a> (<a class="code" href="structID__DCM__HDR.html">ID_DCM_HDR</a> * e) {
00109 
00110    <span class="keywordflow">if</span> (e) {
00111       <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structID__DCM__HDR.html#o16">deb</a>) free(e-&gt;<a class="code" href="structID__DCM__HDR.html#o16">deb</a>);
00112       <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structID__DCM__HDR.html#o19">plist</a>) <a class="code" href="idliste_8h.html#a25">IdLstFree</a>(e-&gt;<a class="code" href="structID__DCM__HDR.html#o19">plist</a>); <span class="comment">// LIBERER LES ELEMENTS DE LA LISTE AVANT</span>
00113       free(e);
00114    }
00115 }
00116 
00117 <span class="comment">/* =======================================================================</span>
00118 <span class="comment"> * _IdDcmSWAP_SHORT</span>
00119 <span class="comment"> *    remet les octets dans un ordre compatible avec celui du processeur</span>
00120 <span class="comment"> *  ======================================================================= */</span>
00121 
<a name="l00122"></a><a class="code" href="iddcm-restricted_8h.html#a6">00122</a> <span class="keywordtype">short</span> <span class="keywordtype">int</span> <a class="code" href="iddcm-restricted_8h.html#a6">_IdDcmSWAP_SHORT</a>(<span class="keywordtype">short</span> <span class="keywordtype">int</span> a,<span class="keywordtype">int</span> sw) {
00123    <span class="keywordflow">if</span> ( (sw==4321)  || (sw==2143) )  
00124       a =(((a&lt;&lt;8) &amp; 0x0ff00) | ((a&gt;&gt;8)&amp;0x00ff));
00125    <span class="keywordflow">return</span> (a);
00126 }
00127 
00128 <span class="comment">/* =======================================================================</span>
00129 <span class="comment"> * _IdDcmSWAP_LONG</span>
00130 <span class="comment"> *    remet les octets dans un ordre compatible avec celui du processeur</span>
00131 <span class="comment"> *  ======================================================================= */</span>
00132 
<a name="l00133"></a><a class="code" href="iddcm-restricted_8h.html#a7">00133</a> uint32_t <a class="code" href="iddcm-restricted_8h.html#a7">_IdDcmSWAP_LONG</a>(uint32_t a, <span class="keywordtype">int</span> sw) {
00134 <span class="comment">/*       ATTENTION: il pourrait y avoir un pb pour les entiers negatifs ...</span>
00135 <span class="comment"> *                                                              </span>
00136 <span class="comment"> */</span>
00137    <span class="keywordflow">switch</span> (sw) {
00138    <span class="keywordflow">case</span> 4321 :
00139       a=(   ((a&lt;&lt;24) &amp; 0xff000000) | ((a&lt;&lt;8)  &amp; 0x00ff0000)    | 
00140          ((a&gt;&gt;8)  &amp; 0x0000ff00) | ((a&gt;&gt;24) &amp; 0x000000ff) );
00141       <span class="keywordflow">break</span>;
00142 
00143    <span class="keywordflow">case</span> 3412 :
00144             a=(   ((a&lt;&lt;16) &amp; 0xffff0000) | ((a&gt;&gt;16) &amp; 0x0000ffff) );
00145       <span class="keywordflow">break</span>;
00146 
00147    <span class="keywordflow">case</span> 2143 :
00148       a=(    ((a&lt;&lt;8) &amp; 0xff00ff00) | ((a&gt;&gt;8) &amp; 0x00ff00ff)  );
00149       <span class="keywordflow">break</span>;
00150    <span class="keywordflow">default</span> :
00151       printf(<span class="stringliteral">"\n\n\n *******\n erreur code swap ?!?\n\n\n"</span>);
00152       a=0;
00153    }
00154   <span class="keywordflow">return</span>(a);
00155 }
00156 
00157 
00158 <span class="preprocessor">#define DEBUG 0</span>
00159 <span class="preprocessor"></span>
00160 <span class="comment">// -----------------------------------------------------------------------------------</span>
<a name="l00168"></a><a class="code" href="iddcm_8h.html#a5">00168</a> <span class="comment"></span><a class="code" href="structID__DCM__HDR.html">ID_DCM_HDR</a> * <a class="code" href="iddcm_8h.html#a5">IdDcmGetHeader</a>(<span class="keywordtype">char</span> *filename) {
00169 
00170 <a class="code" href="structID__DCM__HDR.html">ID_DCM_HDR</a> *e=NULL;
00171 <a class="code" href="struct__ID__DCM__ELEM.html">_ID_DCM_ELEM</a> * ple;
00172 <a class="code" href="struct__elem.html">PLIST_ELEMENT</a> plist_elem;
00173 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> g, n, samplesPerPixel, raws, columns, bitsAllocated;
00174 <span class="keywordtype">char</span> icone, icone_Trouvee;
00175 
00176 
00177    e = <a class="code" href="dcmutil_8c.html#a13">IdDcmHdrAlloc</a>();
00178    <span class="keywordflow">if</span>(!e) {
00179       printf(<span class="stringliteral">"echec alloc HDR \n"</span>);
00180       <span class="keywordflow">return</span>(NULL);
00181    }
00182    
00183    <span class="keywordflow">if</span>((e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>=fopen(filename,<a class="code" href="idio_8h.html#a0">ID_RFILE_BIN</a>))==0) {      <span class="comment">// OK</span>
00184       <span class="comment">// IdDcmHdrAFree(e);</span>
00185       printf (<span class="stringliteral">"echec ouverture  %s\n"</span>,filename);
00186       <span class="keywordflow">return</span> (NULL);
00187         }
00188    
00189    e-&gt;<a class="code" href="structID__DCM__HDR.html#o0">filename</a> = strdup(filename);
00190     
00191    fseek(e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>, 0L, SEEK_END);
00192    <span class="comment">/*</span>
00193 <span class="comment">    * obtains the current value of the file-position    </span>
00194 <span class="comment">    * indicator for the stream pointed to by stream      </span>
00195 <span class="comment">    */</span>
00196    e-&gt;<a class="code" href="structID__DCM__HDR.html#o2">taille_fich</a> = ftell(e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>);
00197    
00198    <span class="keywordflow">if</span>(<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"IdDcmGetHeader : lgr fich %f\n"</span>,(<span class="keywordtype">float</span>)e-&gt;<a class="code" href="structID__DCM__HDR.html#o2">taille_fich</a>); <span class="comment">// FORMAT IMPRESSION long int ???</span>
00199    
00200    rewind(e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>);
00201       
00202    e-&gt;<a class="code" href="structID__DCM__HDR.html#o5">sw</a>= _IdDcmCheckSwap(e);
00203    
00204    <span class="keywordflow">if</span>(e-&gt;<a class="code" href="structID__DCM__HDR.html#o5">sw</a> == -1) {    <span class="comment">// On est assure que c'est NON DICOM, NON ACR</span>
00205       <a class="code" href="iddcm_8h.html#a4">IdDcmHdrFree</a>(e);
00206       <span class="keywordflow">return</span> (NULL);
00207    }
00208    
00209    e-&gt;<a class="code" href="structID__DCM__HDR.html#o15">__NumeroGroupePrecedent</a> = 0; <span class="comment">// Pour etre sur que le premier sera + grand</span>
00210    e-&gt;<a class="code" href="structID__DCM__HDR.html#o10">grPixelTrouve</a> = 0;
00211    e-&gt;<a class="code" href="structID__DCM__HDR.html#o13">PixelsTrouves</a> = 0;
00212    
00213    <span class="keywordflow">while</span> ( (ple=<a class="code" href="iddcm-restricted_8h.html#a3">_IdDcmReadNextElement</a>(e,e-&gt;<a class="code" href="structID__DCM__HDR.html#o5">sw</a>)) ) {
00214       <a class="code" href="idliste_8h.html#a24">IdLstAddLast</a>(e-&gt;<a class="code" href="structID__DCM__HDR.html#o19">plist</a>, ple);
00215       <span class="comment">// --&gt;</span>
00216       <span class="comment">// --&gt; Pour tester</span>
00217       <span class="comment">//if(e-&gt;PixelsTrouves) break;</span>
00218    }
00219    
00220    <span class="comment">// une fois le DCM-Header charge en memoire,</span>
00221    <span class="comment">// on recherche les caracteristiques eventuelle</span>
00222    <span class="comment">// d'une 'icone'</span>
00223       
00224    icone=0;
00225    
00226         plist_elem = <a class="code" href="idliste_8h.html#a17">IdLstFirst</a>(e-&gt;<a class="code" href="structID__DCM__HDR.html#o19">plist</a>);
00227    <span class="keywordflow">while</span> ( plist_elem != NULL) {
00228       ple = <a class="code" href="idliste_8h.html#a22">IdLstPtrObj</a>(plist_elem);
00229       g= ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o0">Gr</a>;
00230       n=ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o1">Num</a>;
00231       <span class="keywordflow">if</span> (g &gt;  0x0008 &amp;&amp; n &gt;  0x2112 ) <span class="keywordflow">break</span>; <span class="comment">// depasse : pas d'icone</span>
00232 
00233       <span class="keywordflow">if</span> (g == 0x0008 &amp;&amp; n == 0x2112) {  <span class="comment">// Source Image Sequence :</span>
00234          icone=1;
00235          <span class="keywordflow">break</span>;
00236       }
00237       plist_elem=<a class="code" href="idliste_8h.html#a20">IdLstNext</a>(plist_elem);   
00238    }
00239    
00240    icone_Trouvee=0;
00241    <span class="keywordflow">if</span> (icone == 1 ) {
00242    
00243       printf (<span class="stringliteral">"rech iconeTrouvee\n"</span>);
00244 
00245       <span class="keywordflow">while</span> ( plist_elem != NULL) {
00246          ple = <a class="code" href="idliste_8h.html#a22">IdLstPtrObj</a>(plist_elem);
00247          g= ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o0">Gr</a>;
00248          n= ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o1">Num</a>;
00249          
00250          <span class="keywordflow">if</span> (g != 0xfffe &amp;&amp; (g &gt;  0x0088 &amp;&amp; n &gt;  0x0200)) <span class="keywordflow">break</span>; <span class="comment">// du soucis a se faire si on sort par ici</span>
00251          <span class="keywordflow">if</span> (g == 0x0088 &amp;&amp; n == 0x0200) {  <span class="comment">// Icone Image Sequence</span>
00252          icone_Trouvee=1;
00253          <span class="keywordflow">break</span>;
00254          }
00255          plist_elem=<a class="code" href="idliste_8h.html#a20">IdLstNext</a>(plist_elem);
00256       }   
00257    }
00258    
00259    <span class="keywordflow">if</span> (icone_Trouvee == 1 ) {
00260    
00261          printf (<span class="stringliteral">"rech valeurs\n"</span>);
00262 
00263       <span class="keywordflow">while</span> ( plist_elem != NULL) {
00264          ple = <a class="code" href="idliste_8h.html#a22">IdLstPtrObj</a>(plist_elem);
00265          g= ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o0">Gr</a>;
00266          <span class="keywordflow">if</span> ( g != 0xfffe &amp;&amp; g &gt; 0x0088) <span class="keywordflow">break</span>; <span class="comment">// on a du tous les trouver</span>
00267          n=ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o1">Num</a>;
00268          <span class="comment">// on est dans la SQ, group vaut 0008 ...          </span>
00269          <span class="keywordflow">if</span>      (n == 0x0002) samplesPerPixel = <a class="code" href="iddcm_8h.html#a0">str2num</a>(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>,<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span>);
00270          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (n == 0x0010) raws            = <a class="code" href="iddcm_8h.html#a0">str2num</a>(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>,<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span>); 
00271          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (n == 0x0011) columns         = <a class="code" href="iddcm_8h.html#a0">str2num</a>(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>,<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span>);
00272          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (n == 0x0100) bitsAllocated   = <a class="code" href="iddcm_8h.html#a0">str2num</a>(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>,<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span>);
00273       
00274          plist_elem  = <a class="code" href="idliste_8h.html#a20">IdLstNext</a>(plist_elem);
00275       } 
00276    }  
00277    
00278    <span class="comment">// on ajuste PixelPosition, pour 'sauter' l'icone.</span>
00279    <span class="keywordflow">if</span> (icone_Trouvee) {
00280    
00281    <span class="comment">// PAS SUFFISANT : il y a des Koshon'ries apres les pixels imagette !</span>
00282    
00283            printf (<span class="stringliteral">"samplesPerPixel %d raws %d  columns %d bitsAllocated %d\n"</span>, 
00284          samplesPerPixel, raws, columns, bitsAllocated);
00285            printf(<span class="stringliteral">"pixelPosition %d x(%x) \n"</span>, 
00286                e-&gt;<a class="code" href="structID__DCM__HDR.html#o14">PixelPosition</a>,e-&gt;<a class="code" href="structID__DCM__HDR.html#o14">PixelPosition</a>);
00287       e-&gt;<a class="code" href="structID__DCM__HDR.html#o14">PixelPosition</a> += samplesPerPixel * raws * columns * bitsAllocated / 8;
00288            printf(<span class="stringliteral">"pixelPosition %d x(%x)\n"</span>,e-&gt;<a class="code" href="structID__DCM__HDR.html#o14">PixelPosition</a>, e-&gt;<a class="code" href="structID__DCM__HDR.html#o14">PixelPosition</a>);
00289    }
00290    
00291    <span class="comment">// Positionnement ACR_LIBIDO</span>
00292    
00293    _setAcrLibido(e);
00294       
00295    fclose(e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>);
00296    <span class="keywordflow">return</span> (e);
00297 }
00298 
00299 <span class="keyword">static</span> <span class="keywordtype">void</span> _setAcrLibido(<a class="code" href="structID__DCM__HDR.html">ID_DCM_HDR</a> *e) {
00300 
00301 <a class="code" href="struct__ID__DCM__ELEM.html">_ID_DCM_ELEM</a> * ple;
00302 <a class="code" href="struct__elem.html">PLIST_ELEMENT</a> plelem;
00303 <a class="code" href="struct__elem.html">PLIST</a> pl;
00304 
00305    <span class="comment">// Positionnement ACR_LIBIDO</span>
00306    <span class="keywordflow">if</span>(<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"Entree ds _setAcrLibido\n"</span>);
00307 
00308    e-&gt;<a class="code" href="structID__DCM__HDR.html#o7">ACR_LIBIDO</a> = 0;
00309    <span class="keywordflow">if</span> ( e-&gt;<a class="code" href="structID__DCM__HDR.html#o9">__TrueDicom</a> == 0) {
00310       <span class="comment">// Recognition Code  --&gt; n'existe plus en DICOM V3 ...</span>
00311       
00312       pl = e-&gt;<a class="code" href="structID__DCM__HDR.html#o19">plist</a>;
00313       plelem = <a class="code" href="idliste_8h.html#a17">IdLstFirst</a>(pl);
00314       <span class="keywordflow">while</span> (plelem) {
00315          ple= <a class="code" href="idliste_8h.html#a22">IdLstPtrObj</a>(plelem);
00316          <span class="keywordflow">if</span>(<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"gr %04x Num %04x\n"</span>, ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o0">Gr</a>, ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o1">Num</a>);
00317          <span class="keywordflow">if</span>(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o0">Gr</a> &gt;  0x0008) <span class="keywordflow">break</span>;     <span class="comment">// On a depasse</span>
00318          <span class="keywordflow">if</span>(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o0">Gr</a> == 0x0008) {
00319             <span class="keywordflow">if</span>(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o1">Num</a> &gt;  0x0010) <span class="keywordflow">break</span>; <span class="comment">// On a depasse</span>
00320             <span class="keywordflow">if</span>(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o1">Num</a> == 0x0010) {
00321                <span class="keywordflow">if</span> (  (memcmp(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>,<span class="stringliteral">"ACRNEMA_LIBIDO"</span>,14)==0)
00322                   <span class="comment">// si c'est egal</span>
00323                   || (memcmp(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>,<span class="stringliteral">"CANRME_AILIBOD"</span>,14)==0)) {
00324                   <span class="comment">// en cas d'objet ACRLibido fait sr 1 autre machine) </span>
00325                   e-&gt;<a class="code" href="structID__DCM__HDR.html#o7">ACR_LIBIDO</a> =1; 
00326                }  <span class="comment">// fin if memcmp</span>
00327                <span class="keywordflow">break</span>;      
00328             } <span class="comment">// fin if ple-&gt;Num==0x0010</span>
00329          } <span class="comment">// fin ple-&gt;Gr==0x0008</span>
00330          plelem = <a class="code" href="idliste_8h.html#a20">IdLstNext</a>(plelem);
00331       } <span class="comment">// fin while </span>
00332    } <span class="comment">// fin if TrueDicom</span>
00333    
00334       <span class="keywordflow">if</span>(<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"ACR_LIBIDO = %d\n"</span>, e-&gt;<a class="code" href="structID__DCM__HDR.html#o7">ACR_LIBIDO</a>);
00335    <span class="keywordflow">return</span>;
00336 }
00337 <span class="comment">/* ======================================================================= </span>
00338 <span class="comment">*  _IdDcmRecupLgr</span>
00339 <span class="comment">*</span>
00340 <span class="comment">*  ACR-NEMA :  On a toujours </span>
00341 <span class="comment">*           GroupNumber   (2 Octets) </span>
00342 <span class="comment">*           ElementNumber (2 Octets) </span>
00343 <span class="comment">*           ElementSize   (4 Octets)</span>
00344 <span class="comment">*</span>
00345 <span class="comment">*</span>
00346 <span class="comment">*  DICOM :     On peut avoir (implicit Value Representation)</span>
00347 <span class="comment">*           GroupNumber   (2 Octets) </span>
00348 <span class="comment">*           ElementNumber (2 Octets) </span>
00349 <span class="comment">*           ElementSize   (4 Octets)</span>
00350 <span class="comment">*</span>
00351 <span class="comment">*        On peut avoir (explicit Value Representation)</span>
00352 <span class="comment">*           GroupNumber         (2 Octets) </span>
00353 <span class="comment">*           ElementNumber       (2 Octets) </span>
00354 <span class="comment">*           ValueRepresentation (2 Octets) </span>
00355 <span class="comment">*           ElementSize         (2 Octets)</span>
00356 <span class="comment">*</span>
00357 <span class="comment">*        ATTENTION : dans le cas ou ValueRepresentation = OB, OW, SQ, UN</span>
00358 <span class="comment">*           GroupNumber         (2 Octets) </span>
00359 <span class="comment">*           ElementNumber       (2 Octets) </span>
00360 <span class="comment">*           ValueRepresentation (2 Octets)</span>
00361 <span class="comment">*           zone reservee       (2 Octets) </span>
00362 <span class="comment">*           ElementSize         (4 Octets)</span>
00363 <span class="comment">*</span>
00364 <span class="comment">*</span>
00365 <span class="comment">*   ======================================================================= */</span>
00380 <span class="keyword">static</span> uint32_t _IdDcmRecupLgr(<a class="code" href="structID__DCM__HDR.html">ID_DCM_HDR</a> *e, <span class="keywordtype">int</span> sw, <span class="keywordtype">int</span> *skippedLength, <span class="keywordtype">int</span> *longueurLue) {
00381 uint32_t l_gr; 
00382 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span> l_gr_2;
00383 <span class="keywordtype">int</span> i, trouve;
00384 <span class="keywordtype">char</span> VR[5];
00385 <span class="keywordtype">int</span> lgrLue;
00386 
00387 <span class="comment">// ID_DCM_HDR *e sert uniquement de passe-plat pour  __ExplicitVR</span>
00388 
00389 
00390 <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structID__DCM__HDR.html#o8">__ExplicitVR</a> == 1) {
00391    lgrLue=fread (&amp;VR, (size_t)2,(size_t)1, e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>);
00392    VR[2]=0;
00393 
00394    <span class="comment">// ATTENTION :</span>
00395    <span class="comment">// Ce n'est pas parce qu'on a trouve UL la premiere fois qu'on respecte </span>
00396    <span class="comment">// Explicit VR tout le temps</span>
00397    <span class="comment">// (cf e=film ...)</span>
00398 
00399    <span class="comment">//for(i=0,trouve=0;i&lt;nbCode;i++) {</span>
00400    
00401      <span class="keywordflow">for</span>(i=0,trouve=0;<a class="code" href="dicom_8c.html#a2">_ID_dicom_vr</a>[i].<a class="code" href="struct____DicomVr____.html#o0">dicom_VR</a> != NULL ;i++) {
00402       <span class="keywordflow">if</span>(memcmp(_ID_dicom_vr[i].dicom_VR,VR,(size_t)2)==0) {
00403          (e-&gt;<a class="code" href="structID__DCM__HDR.html#o18">pleCourant</a>)-&gt;VR=<a class="code" href="dicom_8c.html#a2">_ID_dicom_vr</a>[i].<a class="code" href="struct____DicomVr____.html#o0">dicom_VR</a>;
00404          trouve=1;   
00405          <span class="keywordflow">break</span>;
00406       }
00407    }
00408 
00409    <span class="keywordflow">if</span> ( trouve == 0) {
00410 
00411       <span class="comment">// On est mal : implicit VR repere</span>
00412       <span class="comment">// mais ce n'est pas un code connu ...</span>
00413       <span class="comment">// On reconstitue la longueur</span>
00414       
00415       <span class="keywordflow">if</span>(<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"IdDcmRecupLgr : Explicit VR, mais pas trouve de code connu\n"</span>);
00416       memcpy(&amp;l_gr, VR,(size_t)2);
00417 
00418       lgrLue=fread ( ((<span class="keywordtype">char</span>*)&amp;l_gr)+2, (size_t)2, (size_t)1, e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>);
00419 
00420       <span class="keywordflow">if</span>(sw) l_gr = <a class="code" href="iddcm-restricted_8h.html#a7">_IdDcmSWAP_LONG</a>(((uint32_t)l_gr),sw);
00421       
00422       <span class="keywordflow">if</span>(<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"IdDcmRecupLgr : lgr deduite : %08x , %d\n"</span>,l_gr,l_gr);
00423       
00424       *longueurLue=l_gr;
00425       <span class="keywordflow">if</span> ( (<span class="keywordtype">int</span>)l_gr == -1) { 
00426          l_gr=0;
00427       }
00428       *skippedLength = 4; 
00429       <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">" 1 : lgr %08x (%d )skippedLength %d\n"</span>,l_gr,l_gr, *skippedLength);
00430       <span class="keywordflow">return</span>(l_gr);
00431    }
00432 
00433    <span class="comment">// On repart dans la sequence 'sensee'</span>
00434 
00435    <span class="keywordflow">if</span>(<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"VR : [%01x , %01x] (%c%c) en position %d du tableau\n"</span>, VR[0],VR[1],VR[0],VR[1],i);
00436    <span class="comment">//printf(" %d , %s\n", i,_ID_dicom_vr[i].dicom_VR);</span>
00437    
00438    <span class="keywordflow">if</span> (  
00439       (!memcmp( VR,<span class="stringliteral">"OB"</span>,(size_t)2 )) || 
00440       (!memcmp( VR,<span class="stringliteral">"OW"</span>,(size_t)2 )) || 
00441       (!memcmp( VR,<span class="stringliteral">"SQ"</span>,(size_t)2 )) ||
00442       (!memcmp( VR,<span class="stringliteral">"UN"</span>,(size_t)2 )) ) {
00443 
00444    <span class="comment">// les 2 octets suivants sont reserves</span>
00445 
00446       <span class="keywordflow">if</span>(<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"IdDcmRecupLgr : les 2 octets suivants sont reserves\n"</span>);
00447                <span class="comment">//on les saute    </span>
00448       fseek(e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>, 2L,SEEK_CUR);
00449       
00450                <span class="comment">//on lit la lgr sur QUATRE octets</span>
00451 
00452       lgrLue=fread (&amp;l_gr, (size_t)4,(size_t)1, e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>);
00453 
00454       <span class="keywordflow">if</span>(sw) l_gr = <a class="code" href="iddcm-restricted_8h.html#a7">_IdDcmSWAP_LONG</a>(((uint32_t)l_gr),sw);
00455       *skippedLength = 8;
00456 
00457    } <span class="keywordflow">else</span> {
00458                <span class="comment">//on lit la lgr sur DEUX octets</span>
00459 
00460       lgrLue=fread (&amp;l_gr_2, (size_t)2,(size_t)1, e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>);
00461 
00462       <span class="keywordflow">if</span>(sw) l_gr_2 = <a class="code" href="iddcm-restricted_8h.html#a6">_IdDcmSWAP_SHORT</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)l_gr_2,sw);
00463       
00464       *longueurLue=l_gr_2;
00465 
00466       <span class="keywordflow">if</span> ( l_gr_2 == 0xffff) {
00467          l_gr = 0;   
00468       } <span class="keywordflow">else</span> {
00469          l_gr = l_gr_2;
00470       }
00471       *skippedLength = 4;
00472    }  
00473   } <span class="keywordflow">else</span> {  <span class="comment">// Explicit VR = 0   </span>
00474 
00475             <span class="comment">//on lit la lgr sur QUATRE octets</span>
00476 
00477    lgrLue=fread (&amp;l_gr, (size_t)4,(size_t)1, e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>);
00478 
00479    <span class="keywordflow">if</span>(sw)l_gr=<a class="code" href="iddcm-restricted_8h.html#a7">_IdDcmSWAP_LONG</a>(((<span class="keywordtype">long</span>)l_gr),sw);
00480    *skippedLength = 4;
00481   }
00482   
00483   *longueurLue=l_gr;
00484   
00485   <span class="comment">// Traitement des curiosites sur la longueur</span>
00486   
00487   <span class="keywordflow">if</span> ( (<span class="keywordtype">int</span>)l_gr == 0xffffffff)
00488    l_gr=0; 
00489    
00490   <span class="keywordflow">if</span>(!memcmp( VR,<span class="stringliteral">"SQ"</span>,(size_t)2 )) {   <span class="comment">// ca annonce une SEQUENCE d'items ?!</span>
00491   
00492    <span class="comment">//l_gr=0;                     // on lira donc les items de la sequence </span>
00493    
00494    <span class="comment">// devrait permettre de SAUTER toures les SQ</span>
00495    
00496    <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">" SQ trouve : lgr %d \n"</span>,l_gr);
00497   }
00498    
00499 <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">" 2 : lgr %08x (%d) skippedLength %d\n"</span>,l_gr,l_gr, *skippedLength);
00500   <span class="keywordflow">return</span>(l_gr);
00501 }
00502 
00503 <span class="comment">/* =======================================================================</span>
00504 <span class="comment">   _IdDcmReadNextElement</span>
00505 <span class="comment"></span>
00506 <span class="comment">         lit l'acr_element courant </span>
00507 <span class="comment">         le fichier doit deja avoir ete ouvert, </span>
00508 <span class="comment">                 </span>
00509 <span class="comment">   ======================================================================= */</span>
00510 
00511 
<a name="l00525"></a><a class="code" href="iddcm-restricted_8h.html#a3">00525</a> <a class="code" href="struct__ID__DCM__ELEM.html">_ID_DCM_ELEM</a> * <a class="code" href="iddcm-restricted_8h.html#a3">_IdDcmReadNextElement</a>(<a class="code" href="structID__DCM__HDR.html">ID_DCM_HDR</a> * e, <span class="keywordtype">int</span> sw) {
00526 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> g;
00527 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> n;
00528 uint32_t l;
00529 <span class="keywordtype">long</span> <span class="keywordtype">int</span> posFich;
00530 <span class="keywordtype">int</span> skL;
00531 size_t lgrLue;
00532 <a class="code" href="struct__ID__DCM__ELEM.html">_ID_DCM_ELEM</a> *nouvDcmElem;
00533 
00534    <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">" ===&gt; entree ds _IdDcmReadNextElement\n"</span>);
00535       
00536    <span class="keywordflow">if</span>(e-&gt;<a class="code" href="structID__DCM__HDR.html#o17">offsetCourant</a> ==  e-&gt;<a class="code" href="structID__DCM__HDR.html#o2">taille_fich</a>) { <span class="comment">// On a atteint la fin du fichier</span>
00537       <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">" On a atteint la fin du fichier\n"</span>);
00538       <span class="keywordflow">return</span>(NULL);
00539    } <span class="keywordflow">else</span> {
00540       <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) {
00541             posFich = ftell(e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>);
00542             printf(<span class="stringliteral">"lgrFich %f positionDsFich %f offset courant %f x(%x)\n"</span>, 
00543                      (<span class="keywordtype">float</span>)e-&gt;<a class="code" href="structID__DCM__HDR.html#o2">taille_fich</a>,
00544                      (<span class="keywordtype">float</span>)posFich,
00545                      (<span class="keywordtype">float</span>)e-&gt;<a class="code" href="structID__DCM__HDR.html#o17">offsetCourant</a>,
00546                       e-&gt;<a class="code" href="structID__DCM__HDR.html#o17">offsetCourant</a>);
00547       }
00548    } 
00549    
00550    nouvDcmElem = (<a class="code" href="struct__ID__DCM__ELEM.html">_ID_DCM_ELEM</a> *)malloc(<span class="keyword">sizeof</span>(<a class="code" href="struct__ID__DCM__ELEM.html">_ID_DCM_ELEM</a>));
00551    <span class="keywordflow">if</span> (!nouvDcmElem) {
00552       printf(<span class="stringliteral">"Echec alloc _ID_DCM_ELEM *nouvDcmElem\n"</span>);
00553       <span class="keywordflow">return</span>(NULL);
00554    }
00555    
00556    e-&gt;<a class="code" href="structID__DCM__HDR.html#o18">pleCourant</a> = nouvDcmElem;
00557    
00558    <span class="comment">// ------------------------- Lecture Num group : g</span>
00559 
00560    lgrLue=fread (&amp;g, (size_t)2,(size_t)1, e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>);
00561    
00562    <span class="keywordflow">if</span> (feof(e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>))  {
00563       <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"_IdDcmReadNextElement : eof trouve\n"</span>);        
00564       <span class="keywordflow">return</span> (NULL);
00565    }
00566    <span class="keywordflow">if</span> (ferror(e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>)){
00567       <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">" IdDcmReadNextElement : echec lecture NumGr\n"</span>);
00568       <span class="keywordflow">return</span> (NULL);
00569    }
00570 
00571    <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"_IdDcmReadNextElement : "</span>
00572                <span class="stringliteral">" gr  %04x\n"</span>,g );
00573                   
00574    <span class="keywordflow">if</span> (sw)  g=<a class="code" href="iddcm-restricted_8h.html#a6">_IdDcmSWAP_SHORT</a>(((<span class="keywordtype">short</span>)g),sw);
00575    
00576    nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o0">Gr</a>=g;
00577    e-&gt;<a class="code" href="structID__DCM__HDR.html#o15">__NumeroGroupePrecedent</a> =g;
00578    
00579    <span class="comment">// ------------------------- Lecture Num Elem : n</span>
00580 
00581    lgrLue=fread (&amp;n, (size_t)2,(size_t)1, e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>);
00582    
00583    <span class="keywordflow">if</span> (feof(e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>))  {
00584       <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"_IdDcmReadNextElement : eof trouve\n"</span>);        
00585       <span class="keywordflow">return</span> (NULL);
00586    }
00587    <span class="keywordflow">if</span> (ferror(e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>)){
00588       <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">" IdDcmReadNextElement : echec lecture NumElem\n"</span>);
00589       <span class="keywordflow">return</span> (NULL);
00590    }
00591    
00592    <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"_IdDcmReadNextElement : "</span>
00593                <span class="stringliteral">" num %04x\n"</span>,n );
00594 
00595    <span class="keywordflow">if</span>(sw)n=<a class="code" href="iddcm-restricted_8h.html#a6">_IdDcmSWAP_SHORT</a>(((<span class="keywordtype">short</span>)n),sw);
00596    nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o1">Num</a>=n;
00597 
00598    <span class="comment">// ------------------------- Lecture longueur element : l</span>
00599                         
00600    l = _IdDcmRecupLgr(e, sw, &amp;skL, &amp;nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o2">LgrLueElem</a>);
00601          
00602    <span class="keywordflow">if</span>(g==0xfffe) l=0;  <span class="comment">// pour sauter les indicateurs de 'SQ'</span>
00603 
00604    nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o3">LgrElem</a>=l;
00605 
00606    <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <span class="keywordflow">if</span> (n!=0) printf(<span class="stringliteral">"_IdDcmReadNextElement : "</span>
00607                <span class="stringliteral">" gr %04x\tnum %04x\tlong %08x (%d)\n"</span>,
00608                g,n,l,l);            
00609                
00610    <span class="comment">// ------------------------- Lecture Valeur element </span>
00611       
00612    nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a> = malloc(l+1);
00613    <span class="keywordflow">if</span>(nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>) {
00614       nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>[l]= 0;
00615    } <span class="keywordflow">else</span> { 
00616       <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">" IdDcmReadNextElement : echec Alloc valeurElem lgr : %d\n"</span>,l);
00617       <span class="keywordflow">return</span> (NULL);
00618    }  
00619    
00620    <span class="comment">// ------------------------ On amene en mémoire y compris les Elem 'tres longs'</span>
00621          
00622    lgrLue=fread (nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>, (size_t)l,(size_t)1, e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>);  
00623    
00624    e-&gt;<a class="code" href="structID__DCM__HDR.html#o17">offsetCourant</a> +=  2 + 2 + skL; <span class="comment">// gr +  num + lgr</span>
00625    nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o5">Offset</a> = e-&gt;<a class="code" href="structID__DCM__HDR.html#o17">offsetCourant</a>;
00626    e-&gt;<a class="code" href="structID__DCM__HDR.html#o17">offsetCourant</a> += l;        <span class="comment">// debut elem suivant</span>
00627 
00628 
00629    <span class="comment">// ------------------------- Doit-on le Swapper ?</span>
00630    
00631 
00632    <span class="keywordflow">if</span> ((n==0) &amp;&amp; sw)  { <span class="comment">// n=0 : lgr du groupe : uint32_t</span>
00633          *(uint32_t *) nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a> =
00634                <a class="code" href="iddcm-restricted_8h.html#a7">_IdDcmSWAP_LONG</a>  ((*(uint32_t *) nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>),sw);  
00635          nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o4">Swap</a> = 1;
00636    } <span class="keywordflow">else</span> {
00637       <span class="keywordflow">if</span>(sw) {
00638          <span class="keywordflow">if</span> ( (g/2)*2-g==0) { <span class="comment">/* on ne teste pas les groupes impairs */</span>
00639 
00640             <span class="keywordflow">if</span> ((l==4)||(l==2)) {  <span class="comment">/*pour ne s'interroger que sur les elements </span>
00641 <span class="comment">                              de lgr =2 ou =4 */</span>
00642 
00643                <span class="comment">// On a deja trouve la VR lors de RecupLgr</span>
00644                <span class="comment">// On la reutilise</span>
00645                
00646                <span class="keywordflow">if</span> (    (strcmp(nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o6">VR</a>,<span class="stringliteral">"UL"</span>) ==0) 
00647                    || (strcmp(nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o6">VR</a>,<span class="stringliteral">"US"</span>) ==0)
00648                    || (strcmp(nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o6">VR</a>,<span class="stringliteral">"SL"</span>) ==0) 
00649                    || (strcmp(nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o6">VR</a>,<span class="stringliteral">"SS"</span>) ==0) 
00650                          || (g == 0x0028 &amp;&amp; 
00651                      ( n == 0x0005 || n == 0x0200) )  ) { <span class="comment">// seuls (28,5) de vr RET</span>
00652                                         <span class="comment">//  et (28,200) sont des entiers</span>
00653                                         <span class="comment">// ... jusqu'a preuve du contraire</span>
00654                   nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o4">Swap</a> = 1;
00655 
00656                   <span class="keywordflow">if</span>(l==4) { 
00657                         *(uint32_t *) nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>=
00658                            <a class="code" href="iddcm-restricted_8h.html#a7">_IdDcmSWAP_LONG</a>  ((*(uint32_t *) nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>),sw); 
00659                      nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o10">valInt</a> =
00660                            <a class="code" href="iddcm-restricted_8h.html#a7">_IdDcmSWAP_LONG</a>  ((*(uint32_t *) nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>),sw);       
00661                   } <span class="keywordflow">else</span> {
00662                      <span class="keywordflow">if</span>(l==2) 
00663                       *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)   nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>=
00664                         <a class="code" href="iddcm-restricted_8h.html#a6">_IdDcmSWAP_SHORT</a> ((*(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>),sw);
00665                         
00666                      nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o11">valShort</a> =
00667                         <a class="code" href="iddcm-restricted_8h.html#a6">_IdDcmSWAP_SHORT</a> ((*(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>),sw);
00668                    }
00669                }
00670             } <span class="comment">/* fin if l==2 ==4 */</span>
00671          } <span class="comment">/* fin if g pair */</span>
00672       } <span class="comment">/* fin sw */</span> 
00673    }
00674 
00675    <span class="comment">// ------------------------- A-t-on trouve l'info donnant le 'num groupe' des Pixels ?</span>
00676    
00677                         
00678    <span class="keywordflow">if</span> (!e-&gt;<a class="code" href="structID__DCM__HDR.html#o10">grPixelTrouve</a>) {         <span class="comment">// on n a pas encore trouve les pixels</span>
00679    
00680       <span class="keywordflow">if</span> ( (g == 0x0028 &amp;&amp; n &gt; 0x0200) || g &gt; 0x0028 ) { <span class="comment">// on a depasse (28,200)</span>
00681          e-&gt;<a class="code" href="structID__DCM__HDR.html#o11">grPixel</a>  = 0x7FE0;
00682          e-&gt;<a class="code" href="structID__DCM__HDR.html#o12">numPixel</a> = 0x0010;
00683          e-&gt;<a class="code" href="structID__DCM__HDR.html#o10">grPixelTrouve</a> = 1;
00684          <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"-----------------par defaut, en %04x %04x :-------grPixel %04x numPixel %04x\n"</span>,
00685                g,n,e-&gt;<a class="code" href="structID__DCM__HDR.html#o11">grPixel</a>,e-&gt;<a class="code" href="structID__DCM__HDR.html#o12">numPixel</a>);           
00686       } <span class="keywordflow">else</span> {             <span class="comment">// on est sur (28,200)</span>
00687          <span class="keywordflow">if</span> (g == 0x0028) {
00688             <span class="keywordflow">if</span> (n == 0x0200) {
00689                e-&gt;<a class="code" href="structID__DCM__HDR.html#o10">grPixelTrouve</a> = 1;
00690                
00691                *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>= 
00692                   <a class="code" href="iddcm-restricted_8h.html#a6">_IdDcmSWAP_SHORT</a> ((*(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>),sw);
00693                
00694                e-&gt;<a class="code" href="structID__DCM__HDR.html#o11">grPixel</a> = <a class="code" href="iddcm_8h.html#a0">str2num</a>(nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>, <span class="keywordtype">short</span> <span class="keywordtype">int</span>);
00695                               
00696                
00697                <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structID__DCM__HDR.html#o11">grPixel</a> == 0xE07F) { 
00698                   e-&gt;<a class="code" href="structID__DCM__HDR.html#o11">grPixel</a>=0x7FE0;
00699                }              
00700                
00701                <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"-----------28 200 trouve-------------GrPixel %04x\n"</span>,
00702                               e-&gt;<a class="code" href="structID__DCM__HDR.html#o11">grPixel</a>);
00703                
00704                <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structID__DCM__HDR.html#o11">grPixel</a> != 0x7FE0)     <span class="comment">// Vieux pb Philips</span>
00705                   e-&gt;<a class="code" href="structID__DCM__HDR.html#o12">numPixel</a> = 0x1010;      <span class="comment">// encore utile ??</span>
00706                <span class="keywordflow">else</span>
00707                   e-&gt;<a class="code" href="structID__DCM__HDR.html#o12">numPixel</a> = 0x0010;
00708                <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"------------------------grPixel %04x numPixel %04x\n"</span>,
00709                                  e-&gt;<a class="code" href="structID__DCM__HDR.html#o11">grPixel</a>,e-&gt;<a class="code" href="structID__DCM__HDR.html#o12">numPixel</a>);
00710             }
00711          }  
00712       }  
00713    } <span class="keywordflow">else</span> {             <span class="comment">// on vient de trouver les pixels</span>
00714       <span class="keywordflow">if</span> (g == e-&gt;<a class="code" href="structID__DCM__HDR.html#o11">grPixel</a>) {
00715          <span class="keywordflow">if</span> (n == e-&gt;<a class="code" href="structID__DCM__HDR.html#o12">numPixel</a>) {
00716             e-&gt;<a class="code" href="structID__DCM__HDR.html#o14">PixelPosition</a> = nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o5">Offset</a>; 
00717             e-&gt;<a class="code" href="structID__DCM__HDR.html#o13">PixelsTrouves</a> = 1;
00718          <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">" \t===x=&gt; Pixels Trouves en %d\n"</span>,e-&gt;<a class="code" href="structID__DCM__HDR.html#o14">PixelPosition</a>);          
00719          }  
00720       }
00721    }     
00722    e-&gt;<a class="code" href="structID__DCM__HDR.html#o3">nbElem</a> ++;
00723    <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"nb Elem %d\n"</span>,e-&gt;<a class="code" href="structID__DCM__HDR.html#o3">nbElem</a>);
00724    <span class="keywordflow">return</span>(nouvDcmElem);
00725 }
00726  
00727  
<a name="l00728"></a><a class="code" href="dcmutil_8c.html#a3">00728</a> <span class="preprocessor"> #define DEBUG 0</span>
00729 <span class="preprocessor"></span> 
00730  <span class="comment">/* ============================================================================</span>
00731 <span class="comment"></span>
00732 <span class="comment">   SPESHEUL FUNKSHEUNZ TO READ NAADIN ZOBOROMOK LEONARDO IMAGES</span>
00733 <span class="comment">   </span>
00734 <span class="comment">   N.B. : LEONARDO, c'est la console Siemens .</span>
00735 <span class="comment">      Pendant plusieurs mois, les entetes des images etaient verolees</span>
00736 <span class="comment">      Des longueurs de Champs etaient fausses</span>
00737 <span class="comment">      Ces deux fonctions ne servent qu'a pouvoir relire ces images</span>
00738 <span class="comment">      (on ne les a pas conservées sous une autre forme :-(</span>
00739 <span class="comment"></span>
00740 <span class="comment">  ============================================================================= */</span>
00741   
00742   
00743 
00744 <span class="comment">/* =======================================================================</span>
00745 <span class="comment">   _IdDcmReadNextElementLeonardo</span>
00746 <span class="comment"></span>
00747 <span class="comment">         lit l'acr_element courant (Special images foirées Leonardo)</span>
00748 <span class="comment">         le fichier doit deja avoir ete ouvert, </span>
00749 <span class="comment">                 </span>
00750 <span class="comment">   ======================================================================= */</span>
00751 
00763 <span class="comment">//_ID_DCM_ELEM * _IdDcmReadNextElement(ID_DCM_HDR * e, int sw) {</span>
00764 
<a name="l00765"></a><a class="code" href="iddcm-restricted_8h.html#a9">00765</a> <a class="code" href="struct__ID__DCM__ELEM.html">_ID_DCM_ELEM</a> * <a class="code" href="iddcm-restricted_8h.html#a9">_IdDcmReadNextElementLeonardo</a>(<a class="code" href="structID__DCM__HDR.html">ID_DCM_HDR</a> * e, <span class="keywordtype">int</span> sw) {
00766 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> g;
00767 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> n;
00768 uint32_t l;
00769 <span class="keywordtype">long</span> <span class="keywordtype">int</span> posFich;
00770 <span class="keywordtype">int</span> skL;
00771 size_t lgrLue;
00772 <span class="keywordtype">int</span> i;
00773 <a class="code" href="struct__ID__DCM__ELEM.html">_ID_DCM_ELEM</a> *nouvDcmElem;
00774 
00775    <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">" ===&gt; entree ds _IdDcmReadNextElement\n"</span>);
00776       
00777    <span class="keywordflow">if</span>(e-&gt;<a class="code" href="structID__DCM__HDR.html#o17">offsetCourant</a> ==  e-&gt;<a class="code" href="structID__DCM__HDR.html#o2">taille_fich</a>) { <span class="comment">// On a atteint la fin du fichier</span>
00778       <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">" On a atteint la fin du fichier\n"</span>);
00779       <span class="keywordflow">return</span>(NULL);
00780    } <span class="keywordflow">else</span> {
00781       <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) {
00782             posFich = ftell(e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>);
00783             printf(<span class="stringliteral">"lgrFich %f positionDsFich %f offset courant %f\n"</span>, 
00784                      (<span class="keywordtype">float</span>)e-&gt;<a class="code" href="structID__DCM__HDR.html#o2">taille_fich</a>,
00785                      (<span class="keywordtype">float</span>)posFich,
00786                      (<span class="keywordtype">float</span>)e-&gt;<a class="code" href="structID__DCM__HDR.html#o17">offsetCourant</a>);
00787       }
00788    } 
00789    
00790    nouvDcmElem = (<a class="code" href="struct__ID__DCM__ELEM.html">_ID_DCM_ELEM</a> *)malloc(<span class="keyword">sizeof</span>(<a class="code" href="struct__ID__DCM__ELEM.html">_ID_DCM_ELEM</a>));
00791    <span class="keywordflow">if</span> (!nouvDcmElem) {
00792       printf(<span class="stringliteral">"Echec alloc _ID_DCM_ELEM *nouvDcmElem\n"</span>);
00793       <span class="keywordflow">return</span>(NULL);
00794    }
00795    
00796    e-&gt;<a class="code" href="structID__DCM__HDR.html#o18">pleCourant</a> = nouvDcmElem;
00797    
00798    <span class="comment">// ------------------------- Lecture Num group : g</span>
00799 
00800    lgrLue=fread (&amp;g, (size_t)2,(size_t)1, e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>);
00801    
00802    <span class="keywordflow">if</span> (feof(e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>))  {
00803       <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"_IdDcmReadNextElement : eof trouve\n"</span>);        
00804       <span class="keywordflow">return</span> (NULL);
00805    }
00806    <span class="keywordflow">if</span> (ferror(e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>)){
00807       <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">" IdDcmReadNextElement : echec lecture NumGr\n"</span>);
00808       <span class="keywordflow">return</span> (NULL);
00809    }
00810 
00811    <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"_IdDcmReadNextElement : "</span>
00812                <span class="stringliteral">" gr  %04x\n"</span>,g );
00813                   
00814    <span class="keywordflow">if</span> (sw)  g=<a class="code" href="iddcm-restricted_8h.html#a6">_IdDcmSWAP_SHORT</a>(((<span class="keywordtype">short</span>)g),sw);
00815    
00816    nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o0">Gr</a>=g;
00817    e-&gt;<a class="code" href="structID__DCM__HDR.html#o15">__NumeroGroupePrecedent</a> =g;
00818    
00819    <span class="comment">// ------------------------- Lecture Num Elem : n</span>
00820 
00821    lgrLue=fread (&amp;n, (size_t)2,(size_t)1, e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>);
00822    
00823    <span class="keywordflow">if</span> (feof(e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>))  {
00824       <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"_IdDcmReadNextElement : eof trouve\n"</span>);        
00825       <span class="keywordflow">return</span> (NULL);
00826    }
00827    <span class="keywordflow">if</span> (ferror(e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>)){
00828       <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">" IdDcmReadNextElement : echec lecture NumElem\n"</span>);
00829       <span class="keywordflow">return</span> (NULL);
00830    }
00831    
00832    <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"_IdDcmReadNextElement : "</span>
00833                <span class="stringliteral">" num %04x\n"</span>,n );
00834 
00835    <span class="keywordflow">if</span>(sw)n=<a class="code" href="iddcm-restricted_8h.html#a6">_IdDcmSWAP_SHORT</a>(((<span class="keywordtype">short</span>)n),sw);
00836    nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o1">Num</a>=n;
00837 
00838    <span class="comment">// ------------------------- Lecture longueur element : l</span>
00839                         
00840    l = _IdDcmRecupLgr(e, sw, &amp;skL, &amp;nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o2">LgrLueElem</a>);
00841    
00842 
00843       <span class="comment">// ---------------- images delirantes LEONARDO</span>
00844    
00845       <span class="keywordflow">if</span>( (nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o0">Gr</a> == 0x0009) &amp;&amp; ( (nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o1">Num</a> == 0x1113) || (nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o1">Num</a> == 0x1114) ) )
00846       {
00847       
00848          <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf (<span class="stringliteral">"gr %04x  num %04x LgrElem %d\n"</span>,
00849                   nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o0">Gr</a>, nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o1">Num</a>, nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o3">LgrElem</a>);
00850          l=4;
00851          nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o3">LgrElem</a> =4;
00852          nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o2">LgrLueElem</a> =4;         
00853       }
00854       
00855       <span class="comment">// ---------------fin LEONARDO ---------------------------------------------------</span>
00856       
00857    <span class="keywordflow">if</span>(g==0xfffe) l=0;  <span class="comment">// pour sauter les indicateurs de 'SQ'</span>
00858 
00859    nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o3">LgrElem</a>=l;
00860 
00861    <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <span class="keywordflow">if</span> (n!=0) printf(<span class="stringliteral">"_IdDcmReadNextElement : "</span>
00862                <span class="stringliteral">" gr %04x\tnum %04x\tlong %08x (%d)\n"</span>,
00863                g,n,l,l);            
00864                
00865    <span class="comment">// ------------------------- Lecture Valeur element </span>
00866       
00867    nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a> = malloc(l+1);
00868    <span class="keywordflow">if</span>(nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>) {
00869       nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>[l]= 0;
00870    } <span class="keywordflow">else</span> { 
00871       <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">" IdDcmReadNextElement : echec Alloc valeurElem lgr : %d\n"</span>,l);
00872       <span class="keywordflow">return</span> (NULL);
00873    }  
00874    
00875       <span class="comment">// ------------------------ On amene en mémoire y compris les Elem 'tres longs'</span>
00876          
00877    lgrLue=fread (nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>, (size_t)l,(size_t)1, e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>);  
00878    
00879    e-&gt;<a class="code" href="structID__DCM__HDR.html#o17">offsetCourant</a> +=  2 + 2 + skL; <span class="comment">// gr +  num + lgr</span>
00880    nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o5">Offset</a> = e-&gt;<a class="code" href="structID__DCM__HDR.html#o17">offsetCourant</a>;
00881    e-&gt;<a class="code" href="structID__DCM__HDR.html#o17">offsetCourant</a> += l;                    <span class="comment">// debut elem suivant</span>
00882    
00883    <span class="comment">// ------------------------- Doit-on le Swapper ?</span>
00884    
00885 
00886    <span class="keywordflow">if</span> ((n==0) &amp;&amp; sw)  { <span class="comment">// n=0 : lgr du groupe : uint32_t</span>
00887          *(uint32_t *) nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a> =
00888                <a class="code" href="iddcm-restricted_8h.html#a7">_IdDcmSWAP_LONG</a>  ((*(uint32_t *) nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>),sw);  
00889          nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o4">Swap</a> = 1;
00890    } <span class="keywordflow">else</span> {
00891       <span class="keywordflow">if</span>(sw) {
00892          <span class="keywordflow">if</span> ( (g/2)*2-g==0) { <span class="comment">/* on ne teste pas les groupes impairs */</span>
00893 
00894             <span class="keywordflow">if</span> ((l==4)||(l==2)) {  <span class="comment">/*pour eviter de swapper les chaines </span>
00895 <span class="comment">                              de lgr 2 ou 4 */</span>
00896 
00897                <span class="comment">// On a deja trouve la VR lors de RecupLgr</span>
00898                <span class="comment">// On la reutilise</span>
00899                
00900                <span class="keywordflow">if</span> (    (strcmp(nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o6">VR</a>,<span class="stringliteral">"UL"</span>) ==0) 
00901                    || (strcmp(nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o6">VR</a>,<span class="stringliteral">"US"</span>) ==0)
00902                    || (strcmp(nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o6">VR</a>,<span class="stringliteral">"SL"</span>) ==0) 
00903                    || (strcmp(nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o6">VR</a>,<span class="stringliteral">"SS"</span>) ==0) 
00904                          || (g == 0x0028 &amp;&amp; 
00905                      ( n == 0x0005 || n == 0x0200) )  ) { <span class="comment">// seuls (28,5) de vr RET</span>
00906                                                    <span class="comment">//  et (28,200) sont des entiers</span>
00907                                                    <span class="comment">// ... jusqu'a preuve du contraire</span>
00908                   nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o4">Swap</a> = 1;
00909 
00910                   <span class="keywordflow">if</span>(l==4) { 
00911                         *(uint32_t *) nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>=
00912                            <a class="code" href="iddcm-restricted_8h.html#a7">_IdDcmSWAP_LONG</a>  ((*(uint32_t *) nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>),sw); 
00913                      nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o10">valInt</a> =
00914                            <a class="code" href="iddcm-restricted_8h.html#a7">_IdDcmSWAP_LONG</a>  ((*(uint32_t *) nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>),sw);       
00915                   } <span class="keywordflow">else</span> {
00916                      <span class="keywordflow">if</span>(l==2) 
00917                       *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)   nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>=
00918                         <a class="code" href="iddcm-restricted_8h.html#a6">_IdDcmSWAP_SHORT</a> ((*(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>),sw);
00919                      nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o11">valShort</a> =
00920                         <a class="code" href="iddcm-restricted_8h.html#a6">_IdDcmSWAP_SHORT</a> ((*(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>),sw);
00921                    }
00922                }
00923             } <span class="comment">/* fin if l==2 ==4 */</span>
00924          } <span class="comment">/* fin if g pair */</span>
00925       } <span class="comment">/* fin sw */</span> 
00926    }
00927    
00928    <span class="comment">// ------------------------- A-t-on trouve l'info donnant le 'num groupe' des Pixels ?</span>
00929                         
00930    <span class="keywordflow">if</span> (!e-&gt;<a class="code" href="structID__DCM__HDR.html#o10">grPixelTrouve</a>) {         <span class="comment">// on n a pas encore trouve les pixels</span>
00931       <span class="keywordflow">if</span> (g &gt; 0x0028) {
00932             <span class="keywordflow">if</span> (n &gt; 0x0200 || g == 0x7FE0 ) {  <span class="comment">// on a depasse (28,200)</span>
00933                e-&gt;<a class="code" href="structID__DCM__HDR.html#o11">grPixel</a>  = 0x7FE0;
00934                e-&gt;<a class="code" href="structID__DCM__HDR.html#o12">numPixel</a> = 0x0010;
00935                e-&gt;<a class="code" href="structID__DCM__HDR.html#o10">grPixelTrouve</a> = 1;
00936                <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"------------------------grPixel %04x numPixel %04x\n"</span>,
00937                               e-&gt;<a class="code" href="structID__DCM__HDR.html#o11">grPixel</a>,e-&gt;<a class="code" href="structID__DCM__HDR.html#o12">numPixel</a>);
00938             }
00939                   
00940       } <span class="keywordflow">else</span> {             <span class="comment">// on est sur (28,200)</span>
00941          <span class="keywordflow">if</span> (g == 0x0028) {
00942             <span class="keywordflow">if</span> (n == 0x0200) {
00943                e-&gt;<a class="code" href="structID__DCM__HDR.html#o10">grPixelTrouve</a> = 1;
00944                <span class="keywordflow">for</span>(i=0;i&lt;4;i++)
00945                   *((<span class="keywordtype">char</span>*)(&amp;e-&gt;<a class="code" href="structID__DCM__HDR.html#o11">grPixel</a>)+i) = *(nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>+i); 
00946                
00947                
00948                <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"------------------------GrPixel %04x\n"</span>,
00949                               e-&gt;<a class="code" href="structID__DCM__HDR.html#o11">grPixel</a>);
00950                
00951                <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structID__DCM__HDR.html#o11">grPixel</a> != 0x7FE0)     <span class="comment">// Vieux pb Philips</span>
00952                   e-&gt;<a class="code" href="structID__DCM__HDR.html#o12">numPixel</a> = 0x1010;      <span class="comment">// encore utile ??</span>
00953                <span class="keywordflow">else</span>
00954                   e-&gt;<a class="code" href="structID__DCM__HDR.html#o12">numPixel</a> = 0x0010;
00955                   <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"------------------------grPixel %04x numPixel %04x\n"</span>,
00956                                  e-&gt;<a class="code" href="structID__DCM__HDR.html#o11">grPixel</a>,e-&gt;<a class="code" href="structID__DCM__HDR.html#o12">numPixel</a>);
00957             }
00958          }  
00959       }  
00960    } <span class="keywordflow">else</span> {             <span class="comment">// on vient de trouver les pixels</span>
00961       <span class="keywordflow">if</span> (g == e-&gt;<a class="code" href="structID__DCM__HDR.html#o11">grPixel</a>) {
00962          <span class="keywordflow">if</span> (n == e-&gt;<a class="code" href="structID__DCM__HDR.html#o12">numPixel</a>) {
00963             e-&gt;<a class="code" href="structID__DCM__HDR.html#o14">PixelPosition</a> = nouvDcmElem-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o5">Offset</a>; 
00964             e-&gt;<a class="code" href="structID__DCM__HDR.html#o13">PixelsTrouves</a> = 1;
00965          <span class="comment">/*if (DEBUG)*/</span>printf(<span class="stringliteral">" \t=$$$$$$$==&gt; Pixels Trouves en %d\n"</span>,e-&gt;<a class="code" href="structID__DCM__HDR.html#o14">PixelPosition</a>);              
00966          }  
00967       }
00968    }
00969    e-&gt;<a class="code" href="structID__DCM__HDR.html#o3">nbElem</a> ++;
00970    <span class="keywordflow">return</span>(nouvDcmElem);
00971 }
00972  
00973  
00974  <span class="comment">// -----------------------------------------------------------------------------------</span>
<a name="l00982"></a><a class="code" href="iddcm-restricted_8h.html#a10">00982</a> <span class="comment"></span><a class="code" href="structID__DCM__HDR.html">ID_DCM_HDR</a> * <a class="code" href="iddcm-restricted_8h.html#a10">IdDcmGetHeaderLeonardo</a>(<span class="keywordtype">char</span> *filename) {
00983 
00984 <a class="code" href="structID__DCM__HDR.html">ID_DCM_HDR</a> *e=NULL;
00985 <a class="code" href="struct__ID__DCM__ELEM.html">_ID_DCM_ELEM</a> * ple;
00986 
00987    e = <a class="code" href="dcmutil_8c.html#a13">IdDcmHdrAlloc</a>();
00988    <span class="keywordflow">if</span>(!e) {
00989       printf(<span class="stringliteral">"echec alloc HDR \n"</span>);
00990       <span class="keywordflow">return</span>(NULL);
00991    }
00992    
00993    <span class="keywordflow">if</span>((e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>=fopen(filename,<a class="code" href="idio_8h.html#a0">ID_RFILE_BIN</a>))==0) {      <span class="comment">// OK</span>
00994       <span class="comment">// IdDcmHdrAFree(e);</span>
00995       printf (<span class="stringliteral">"echec ouverture  %s\n"</span>,filename);
00996       <span class="keywordflow">return</span> (NULL);
00997         }
00998    
00999    e-&gt;<a class="code" href="structID__DCM__HDR.html#o0">filename</a> = strdup(filename);
01000     
01001    fseek(e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>, 0L, SEEK_END);
01002    <span class="comment">/*</span>
01003 <span class="comment">    * obtains the current value of the file-position    </span>
01004 <span class="comment">    * indicator for the stream pointed to by stream      </span>
01005 <span class="comment">    */</span>
01006    e-&gt;<a class="code" href="structID__DCM__HDR.html#o2">taille_fich</a> = ftell(e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>);
01007    
01008    <span class="keywordflow">if</span>(<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"IdDcmGetHeader : lgr fich %f\n"</span>,(<span class="keywordtype">float</span>)e-&gt;<a class="code" href="structID__DCM__HDR.html#o2">taille_fich</a>); <span class="comment">// FORMAT IMPRESSION long int ???</span>
01009    
01010    rewind(e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>);
01011       
01012    e-&gt;<a class="code" href="structID__DCM__HDR.html#o5">sw</a>= _IdDcmCheckSwap(e);
01013    e-&gt;<a class="code" href="structID__DCM__HDR.html#o15">__NumeroGroupePrecedent</a> = 0; <span class="comment">// Pour etre sur que le premier sera + grand</span>
01014    e-&gt;<a class="code" href="structID__DCM__HDR.html#o10">grPixelTrouve</a> = 0;
01015    e-&gt;<a class="code" href="structID__DCM__HDR.html#o13">PixelsTrouves</a> = 0;
01016 
01017    
01018    <span class="keywordflow">while</span> ( (ple=<a class="code" href="iddcm-restricted_8h.html#a9">_IdDcmReadNextElementLeonardo</a>(e,e-&gt;<a class="code" href="structID__DCM__HDR.html#o5">sw</a>)) ) {
01019       <a class="code" href="idliste_8h.html#a24">IdLstAddLast</a>(e-&gt;<a class="code" href="structID__DCM__HDR.html#o19">plist</a>, ple);
01020    }
01021    
01022    <span class="comment">// Positionnement ACR_LIBIDO</span>
01023    
01024    _setAcrLibido(e);
01025       
01026    fclose(e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>);
01027    <span class="keywordflow">return</span> (e);
01028 }
01029 
01030 
01031  
01032 <span class="comment">/* ============================================================================</span>
01033 <span class="comment"></span>
01034 <span class="comment">   END OF SPESHEUL FUNKSHEUNZ TO READ NAADIN ZOBOROMOK LEONARDO IMAGES</span>
01035 <span class="comment"></span>
01036 <span class="comment">  ============================================================================= */</span>
01037   
01038   
01039 
01040 <span class="comment">/* =======================================================================</span>
01041 <span class="comment"></span>
01042 <span class="comment">   _IdDcmCheckSwap</span>
01043 <span class="comment">      La seule maniere sure que l'on aie pour determiner </span>
01044 <span class="comment">      si on est en   LITTLE_ENDIAN,       BIG-ENDIAN, </span>
01045 <span class="comment">                  BAD-LITTLE-ENDIAN, BAD-BIG-ENDIAN</span>
01046 <span class="comment">      est de trouver l'element qui donne la longueur d'un 'GROUP'</span>
01047 <span class="comment">      (on sait que la longueur de cet element vaut 0x00000004)</span>
01048 <span class="comment">      et de regarder comment cette longueur est codee en memoire  </span>
01049 <span class="comment"></span>
01050 <span class="comment">      Le probleme vient de ce que parfois, il n'y en a pas ...</span>
01051 <span class="comment"></span>
01052 <span class="comment">      On fait alors le pari qu'on a a faire a du LITTLE_ENDIAN propre.</span>
01053 <span class="comment">      (Ce qui est la norme -pas respectee- depuis ACR-NEMA)</span>
01054 <span class="comment">      Si ce n'est pas le cas, on ne peut rien faire.</span>
01055 <span class="comment"></span>
01056 <span class="comment">      (il faudrait avoir des fonctions auxquelles </span>
01057 <span class="comment">       on passe le code Swap en parametre, pour faire des essais 'manuels')</span>
01058 <span class="comment"></span>
01059 <span class="comment">   ======================================================================= */</span>
01060 
01061 <span class="keyword">static</span> <span class="keywordtype">int</span>
01062 _IdDcmCheckSwap(<a class="code" href="structID__DCM__HDR.html">ID_DCM_HDR</a> * e) {
01063 uint32_t  s, <a class="code" href="jerror_8h.html#a52a35">x</a>=4;  <span class="comment">// x : pour ntohs</span>
01064 
01065 <span class="keywordtype">int</span> sw;
01066 <span class="keywordtype">int</span> lgrLue;
01067 <span class="keywordtype">char</span> * entCur;
01068 <span class="keywordtype">char</span> <a class="code" href="imalabel_8c.html#a3">deb</a>[<a class="code" href="dcmutil_8c.html#a0">LGR_ENTETE_A_LIRE</a>];
01069 <span class="keywordtype">short</span> <span class="keywordtype">int</span> shortS;
01070 
01071 
01072 <span class="comment">// On teste le processeur</span>
01073 
01074    <span class="keywordflow">if</span> (<a class="code" href="jerror_8h.html#a52a35">x</a>==(<a class="code" href="jerror_8h.html#a52a35">x</a>)) {  <span class="comment">/* si le HostByteOrder est le meme que le NetworkByteOrder  */</span> 
01075       e-&gt;<a class="code" href="structID__DCM__HDR.html#o6">net2host</a> = 1;
01076    } <span class="keywordflow">else</span> {
01077       e-&gt;<a class="code" href="structID__DCM__HDR.html#o6">net2host</a> = 0;
01078    }
01079    
01080    <span class="comment">//printf("\t\t\t\te-&gt;net2host %d \n",e-&gt;net2host);</span>
01081    
01082 <span class="comment">/* On commence par verifier si c'est du DICOM 'actuel' */</span>
01083 <span class="comment">/*                                      -------------  */</span>
01084 
01085    lgrLue = fread(deb,1,LGR_ENTETE_A_LIRE,e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>);
01086 
01087    entCur = <a class="code" href="imalabel_8c.html#a3">deb</a>+128;
01088    <span class="keywordflow">if</span>(memcmp(entCur, <span class="stringliteral">"DICM"</span>, (size_t)4) == 0) {
01089       e-&gt;<a class="code" href="structID__DCM__HDR.html#o9">__TrueDicom</a>=1;
01090       <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf (<span class="stringliteral">"_IdDcmCheckSwap : C est du DICOM actuel \n"</span>);
01091    } <span class="keywordflow">else</span> {
01092       e-&gt;<a class="code" href="structID__DCM__HDR.html#o9">__TrueDicom</a>=0;
01093       <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf (<span class="stringliteral">"_IdDcmCheckSwap : Ce n'est PAS du DICOM actuel\n"</span>); 
01094    }
01095 
01096    <span class="keywordflow">if</span>(e-&gt;<a class="code" href="structID__DCM__HDR.html#o9">__TrueDicom</a>) {
01097       entCur = <a class="code" href="imalabel_8c.html#a3">deb</a>+136; <span class="comment">/* on saute le File Preamble (souvent a ZERO) : 128 Octets */</span>
01098                <span class="comment">/* le DICM, et le 0002, 0000 ou le 0002, 0001              */</span>
01099          <span class="keywordflow">if</span>( (memcmp(entCur, <span class="stringliteral">"UL"</span>, (size_t)2) == 0) ||
01100              (memcmp(entCur, <span class="stringliteral">"OB"</span>, (size_t)2) == 0) )
01101             {
01102             <span class="comment">/* les 2 premiers octets de la lgr peuvent valoir UL --&gt; Explicit VR */</span>
01103          e-&gt;<a class="code" href="structID__DCM__HDR.html#o8">__ExplicitVR</a> = 1;
01104          <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>)  printf (<span class="stringliteral">"_IdDcmCheckSwap : Explicit VR\n"</span>);
01105             } <span class="keywordflow">else</span> {
01106             e-&gt;<a class="code" href="structID__DCM__HDR.html#o8">__ExplicitVR</a> = 0;
01107          <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>)  printf (<span class="stringliteral">"_IdDcmCheckSwap : PAS Explicit VR\n"</span>);
01108             }
01109 
01110          <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structID__DCM__HDR.html#o6">net2host</a> == 0) { <span class="comment">/* si le HostByteOrder est different du NetworkByteOrder  */</span> 
01111          sw = 0;        <span class="comment">/* on est sur PC ou DEC --&gt; LITTLE-ENDIAN -&gt; Rien a faire */</span>
01112          <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"HostByteOrder = NetworkByteOrder\n"</span>);
01113    
01114          } <span class="keywordflow">else</span> {    <span class="comment">/* on est sur une Sun ou une SGI */</span>
01115          sw = 4321;
01116          <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"HostByteOrder != NetworkByteOrder\n"</span>);
01117          }
01118        
01119       rewind(e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>);
01120       fseek (e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>, 132L, SEEK_SET); <span class="comment">//On se positionne sur le debut des info</span>
01121       e-&gt;<a class="code" href="structID__DCM__HDR.html#o17">offsetCourant</a>=132;
01122       <span class="keywordflow">return</span> sw;
01123 
01124    } <span class="comment">/* fin TrueDicom */</span>
01125    
01126 <span class="comment">/* -----  SINON ----- */</span>
01127    
01128 <span class="comment">/* Si c'est de l'ACR 'propre', la lgr du premier element du groupe est FORCEMENT 4 */</span>
01129 
01130    entCur=<a class="code" href="imalabel_8c.html#a3">deb</a> + 4;
01131    s=<a class="code" href="iddcm_8h.html#a0">str2num</a>(entCur,<span class="keywordtype">int</span>);
01132        
01133       <span class="keywordflow">switch</span> (s) {
01134       <span class="keywordflow">case</span> 0x00040000 :
01135          sw=3412; <span class="keywordflow">if</span>(<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"s : %08x sw : %d\n"</span>,s,sw);
01136          <span class="keywordflow">break</span>;
01137       <span class="keywordflow">case</span> 0x04000000 :
01138          sw=4321; <span class="keywordflow">if</span>(<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"s : %08x sw : %d\n"</span>,s,sw);
01139          <span class="keywordflow">break</span>;
01140       <span class="keywordflow">case</span> 0x00000400 :
01141          sw=2143; <span class="keywordflow">if</span>(<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"s : %08x sw : %d\n"</span>,s,sw);
01142          <span class="keywordflow">break</span>;
01143       <span class="keywordflow">case</span> 0x00000004 :
01144          sw=0;    <span class="keywordflow">if</span>(<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"s : %08x sw : %d\n"</span>,s,sw);
01145          <span class="keywordflow">break</span>;
01146       <span class="keywordflow">default</span> :
01147          sw = -1;
01148                <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf (<span class="stringliteral">" Pas trouve l info de Swap; On va parier\n"</span>);
01149    }
01150       
01151 <span class="comment">/* Si c'est de l'ACR 'pas propre', il manque la lgr du groupe     */</span>
01152             
01153    <span class="keywordflow">if</span>(sw==-1) {                  
01154       <span class="comment">/* On n'a pas trouve l'info de swap (lgr de l'elem (0008,0000) = 4) */</span>
01155       <span class="comment">/* Si c'est du VRAI ACR NEMA  on DOIT trouver le numero du premier groupe : 0008 */</span>
01156       <span class="comment">/* Les seules possibilités sont (Good)BigEndian,(Good)LittleEndian      </span>
01157 <span class="comment">      */</span>
01158          
01159       shortS=<a class="code" href="iddcm_8h.html#a0">str2num</a>(deb,<span class="keywordtype">short</span> <span class="keywordtype">int</span>);
01160       
01161             <span class="keywordflow">switch</span> (shortS) {
01162             <span class="keywordflow">case</span> 0x0008 :
01163                sw=0; 
01164                <span class="keywordflow">if</span>(<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"shortS : %04x sw : %d\n"</span>,shortS,sw);
01165                <span class="keywordflow">break</span>;
01166             <span class="keywordflow">case</span> 0x0800 :
01167                sw=4321; 
01168                <span class="keywordflow">if</span>(<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"shortS : %08x sw : %d\n"</span>,shortS,sw);
01169                <span class="keywordflow">break</span>;
01170             <span class="keywordflow">default</span> :
01171             sw = -1;
01172                   <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf (<span class="stringliteral">" Meme pas trouve 0008 (premier groupe); c est du RAW\n"</span>);
01173       }
01174    }
01175    rewind(e-&gt;<a class="code" href="structID__DCM__HDR.html#o1">fp</a>);    <span class="comment">// les info commencent au debut</span>
01176    e-&gt;<a class="code" href="structID__DCM__HDR.html#o17">offsetCourant</a>=0;
01177    <span class="keywordflow">return</span> (sw);
01178 }
01179 
01180 
01181 <span class="comment">//</span>
01182 <span class="comment">/* ================================================================== */</span>
01183 <span class="comment">//</span>
01184 
01200 <span class="comment">/* Pour rajouter une entree ici,</span>
01201 <span class="comment"></span>
01202 <span class="comment">   penser a modifier le fichier dicom.c</span>
01203 <span class="comment">   penser a modifier la fonction idacr.h</span>
01204 <span class="comment"></span>
01205 <span class="comment">   pour maintenir la coherence.</span>
01206 <span class="comment">*/</span>
01207 
01208 <span class="keywordtype">char</span> **
<a name="l01209"></a><a class="code" href="iddcm_8h.html#a17">01209</a> <a class="code" href="iddcm_8h.html#a17">IdDcmInquireImageInfoFromFile</a>(<span class="keywordtype">char</span> *filename) {
01210 
01211    <a class="code" href="structID__DCM__HDR.html">ID_DCM_HDR</a> *e;
01212    <span class="keywordtype">char</span> **imageInfo;
01213 
01214    e = <a class="code" href="iddcm_8h.html#a5">IdDcmGetHeader</a>(filename);
01215 
01216    <span class="keywordflow">if</span> (!e) {
01217       printf(<span class="stringliteral">"fichier %s : gros problème :\n"</span>, filename);
01218       <a class="code" href="iderr_8h.html#a65">IdErrno</a> = <a class="code" href="iderr_8h.html#a25">IDERR_NON_ACR_FILE</a>;
01219       <span class="keywordflow">return</span> (0);
01220    }
01221    imageInfo = <a class="code" href="dcmutil_8c.html#a11">_IdDcmInquireImageInfoXXX</a>(e, NULL);
01222    
01223    <span class="comment">// LIBERER LE HEADER</span>
01224 
01225    <span class="keywordflow">return</span> (imageInfo);
01226 }
01227 
01228 
01229 <span class="comment">//</span>
01230 <span class="comment">/* ================================================================== */</span>
01231 <span class="comment">//</span>
01232 
01248 <span class="comment">/* Pour rajouter une entree ici,</span>
01249 <span class="comment"></span>
01250 <span class="comment">   penser a modifier le fichier dicom.c</span>
01251 <span class="comment">   penser a modifier la fonction idacr.h</span>
01252 <span class="comment"></span>
01253 <span class="comment">   pour maintenir la coherence.</span>
01254 <span class="comment">*/</span>
01255 
01256 <span class="keywordtype">char</span> **
<a name="l01257"></a><a class="code" href="iddcm_8h.html#a18">01257</a> <a class="code" href="iddcm_8h.html#a18">IdDcmInquireImageInfoFromDcmHdr</a>(<a class="code" href="structID__DCM__HDR.html">ID_DCM_HDR</a> *e)
01258 {
01259    <span class="keywordtype">char</span> **imageInfo;
01260 
01261    <span class="keywordflow">if</span> (!e) {
01262       printf(<span class="stringliteral">"ID_DCM_HDR pas alloue\n"</span>);
01263       <a class="code" href="iderr_8h.html#a65">IdErrno</a> = <a class="code" href="iderr_8h.html#a25">IDERR_NON_ACR_FILE</a>;
01264       <span class="keywordflow">return</span> (0);
01265    }
01266 
01267    imageInfo = <a class="code" href="dcmutil_8c.html#a11">_IdDcmInquireImageInfoXXX</a>(e, NULL);
01268 
01269    <span class="keywordflow">return</span> (imageInfo);
01270 }
01271 
01272 <span class="comment">/* ----------------------------------------------------------------------- */</span>
01273 
01274     <span class="keywordtype">char</span> **
<a name="l01275"></a><a class="code" href="dcmutil_8c.html#a11">01275</a> <a class="code" href="dcmutil_8c.html#a11">_IdDcmInquireImageInfoXXX</a>(<a class="code" href="structID__DCM__HDR.html">ID_DCM_HDR</a> *e, <span class="keywordtype">char</span> **imageInfo)
01276 {
01277 
01278 <span class="keywordtype">int</span> boolTrouveQqChose=0,trouv,k;
01279 
01280 <a class="code" href="struct____dicom__info____.html">DICOM_INFO</a> *t;
01281 t = <a class="code" href="dicom_8c.html#a0">_ID_dicom_info</a>;
01282    
01283    <span class="keywordflow">if</span> (!imageInfo)
01284       imageInfo =
01285           (<span class="keywordtype">char</span> **) calloc (1, <a class="code" href="idacr_8h.html#a115a71">_ID_Number_of_Items</a> + 1);
01286 
01287    <span class="keywordflow">for</span>(k=0;k&lt;<a class="code" href="idacr_8h.html#a115a71">_ID_Number_of_Items</a>;k++) {
01288       trouv=_IdDcmLireEtStockerElement(e, imageInfo,t[k].dicom_group, t[k].dicom_elem,
01289                t[k].dicom_info_libelle, t[k].dicom_info_ind);
01290       <span class="keywordflow">if</span>(trouv) boolTrouveQqChose=1;
01291    }
01292 
01293         <span class="keywordflow">if</span>(boolTrouveQqChose)
01294       <span class="keywordflow">return</span> (imageInfo);
01295    <span class="keywordflow">else</span>
01296       <span class="keywordflow">return</span>(0);
01297 }
01298 
01299 <span class="comment">/* -----------------------------------------------------------------------</span>
01300 <span class="comment">*  ID_DCM_HDR *e :       doit avoir ete cree   dans l'appelant</span>
01301 <span class="comment">*   char **TableauImageInfo : doit avoir ete alloue dans l'appelant; </span>
01302 <span class="comment">*            ses elements sont alloues dans la fonction</span>
01303 <span class="comment">*  int numGroupe :       gr et el du Tag DICOM</span>
01304 <span class="comment">*  int numElem</span>
01305 <span class="comment">*  char *nomElem :       libelle imprime si element pas trouve</span>
01306 <span class="comment">*  int position :     indice dans TableauImageInfo</span>
01307 <span class="comment">  -----------------------------------------------------------------------*/</span>
01308 <span class="keyword">static</span> <span class="keywordtype">int</span> 
01309 _IdDcmLireEtStockerElement(<a class="code" href="structID__DCM__HDR.html">ID_DCM_HDR</a> *e, <span class="keywordtype">char</span> **TableauImageInfo, <span class="keywordtype">int</span> numGroupe,
01310          <span class="keywordtype">int</span> numElem, <span class="keywordtype">char</span> *nomElem, <span class="keywordtype">int</span> position) {
01311    <span class="keywordtype">int</span> z;
01312    <span class="keywordtype">char</span> *chaine;
01313 
01314    <span class="comment">/*</span>
01315 <span class="comment">    * Lecture Element </span>
01316 <span class="comment">    */</span>
01317     <span class="comment">//if (!( chaine = _IdDcmReadElement(numGroupe, numElem, e) )) {</span>
01318    <span class="keywordflow">if</span> (!( chaine = <a class="code" href="iddcm-restricted_8h.html#a2">_IdDcmReadElementNoSQ</a>(numGroupe, numElem, e) )) {
01319 
01320       <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>)
01321          printf
01322              (<span class="stringliteral">"%d : _IdDcmLireEtStockerElement : "</span>
01323               <span class="stringliteral">"%s (%04x,%04x) pas trouve \n"</span>,
01324               position, nomElem, numGroupe, numElem);
01325 
01326       <span class="keywordflow">return</span> (0);
01327    } <span class="keywordflow">else</span> {
01328       <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>)
01329          printf
01330              (<span class="stringliteral">"%d : _IdDcmLireEtStockerElement : "</span>
01331               <span class="stringliteral">"%s (%04x,%04x) \t[%s] \n"</span>,
01332               position, nomElem, numGroupe, numElem,chaine);
01333 
01334       z = strlen(chaine);
01335       <span class="keywordflow">while</span> (chaine[z] == <span class="charliteral">' '</span>) {
01336          chaine[z] = 0;
01337          z--;
01338       }
01339 
01340       TableauImageInfo[position] =
01341           (<span class="keywordtype">char</span> *) malloc(1 + strlen(chaine));
01342       strcpy(TableauImageInfo[position], chaine);
01343       <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>)
01344          printf
01345              (<span class="stringliteral">"%d : %s (_IdDcmLireEtStockerElement : "</span>
01346               <span class="stringliteral">"%04x,%04x)\t[%s]\n"</span>,
01347               position, nomElem, numGroupe, numElem,
01348               chaine);
01349 
01350       <span class="keywordflow">return</span> (1);
01351    }
01352 }
01353 
01354 <span class="comment">// Converts an integer represented with num_byte bytes within the</span>
01355 <span class="comment">// buffer buff to a string.</span>
01356 <span class="comment">// Refer to comp.lang.faq FAQ, question 12.21 : How can I tell how much</span>
01357 <span class="comment">// destination buffer space I'll need for an arbitrary sprintf call? How can</span>
01358 <span class="comment">// I avoid overflowing the destination buffer with sprintf? </span>
01359 
01360 <span class="keyword">static</span> <span class="keywordtype">char</span> * var_itoa(<span class="keywordtype">void</span> * buff, <span class="keywordtype">int</span> num_byte)
01361 {
01362    <span class="keywordtype">char</span> * retbuf;
01363 
01364    <span class="comment">// We double the recommended value since we also have to deal</span>
01365    <span class="comment">// with long integers. Pfff...</span>
01366 <span class="preprocessor">#define CHAR_BIT 8</span>
01367 <span class="preprocessor"></span>   retbuf = malloc(2 * ( (<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * CHAR_BIT + 2) / 3 + 1 + 1));
01368    <span class="keywordflow">switch</span> (num_byte) {
01369    <span class="keywordflow">case</span> 2:
01370       sprintf(retbuf, <span class="stringliteral">"%d"</span>,  *((<span class="keywordtype">int</span>*)buff));
01371       <span class="keywordflow">break</span>;
01372    <span class="keywordflow">case</span> 4:
01373       sprintf(retbuf, <span class="stringliteral">"%dl"</span>, *((<span class="keywordtype">int</span>*)buff));
01374       <span class="keywordflow">break</span>;
01375    <span class="keywordflow">default</span>:
01376       sprintf(retbuf, <span class="stringliteral">"var_itoa?????"</span>);
01377    }
01378    <span class="keywordflow">return</span> retbuf;
01379 }
01380 
01381 
01382 <span class="comment">/* =======================================================================</span>
01383 <span class="comment">   int _IdStrGetDicomTag(char * label, int *gr, int * num, char *vr)</span>
01384 <span class="comment"></span>
01385 <span class="comment">                     recherche le Dicom tag d'un libelle donne</span>
01386 <span class="comment">         par inspection du Dictionnaire DICOM</span>
01387 <span class="comment">                          (retourne 0 si pas trouve)                        </span>
01388 <span class="comment">   ======================================================================= */</span>
01389    
01390 
01391 
01392 <span class="keyword">static</span> <span class="keywordtype">int</span> _IdStrGetDcmTag (<span class="keywordtype">char</span>* libelle, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *gr, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *num, <span class="keywordtype">char</span> **vr) {
01393 
01394 <a class="code" href="struct____Dicom____el____.html">DICOM_ELEMENTS</a> *t;
01395 <span class="keywordtype">int</span> i;
01396 
01397 t=<a class="code" href="dicom_8c.html#a3">_ID_dicom_elements</a>;
01398 
01399 <span class="keywordflow">for</span> (i=0; t[i].<a class="code" href="struct____Dicom____el____.html#o0">dicom_group</a> != 0xffff; i++) {
01400    <span class="keywordflow">if</span>( strcmp(t[i].dicom_libelle, libelle) ==0 )
01401 
01402     {
01403       *gr= t[i].<a class="code" href="struct____Dicom____el____.html#o0">dicom_group</a>;
01404       *num=t[i].dicom_elem;
01405        *vr =t[i].dicom_type;
01406       <span class="keywordflow">return</span>(1);
01407    }
01408 }
01409 <span class="keywordflow">return</span>(0);
01410 
01411 }
01412 
01413 
01431 <span class="keywordtype">char</span> *
<a name="l01432"></a><a class="code" href="iddcm_8h.html#a23">01432</a> <a class="code" href="iddcm_8h.html#a23">_IdDcmReadElementFromLabel</a>(<span class="keywordtype">char</span> *libelle, <a class="code" href="structID__DCM__HDR.html">ID_DCM_HDR</a> *e, <span class="keywordtype">char</span> * vr, <span class="keywordtype">void</span> *buff) { 
01433    
01434    <span class="keywordtype">int</span> i;
01435    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> gr;
01436    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> num;
01437    <span class="keywordtype">char</span> * caster;
01438    
01439    i = _IdStrGetDcmTag (libelle, &amp;gr, &amp;num, &amp;vr);
01440    
01441    <span class="keywordflow">if</span> (i == 0) {
01442       <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"champ [%s] pas trouve\n"</span>,libelle);
01443       caster = malloc(4);
01444       sprintf(caster, <span class="stringliteral">"???"</span>);
01445       <span class="keywordflow">return</span> (caster);
01446       <span class="comment">//return (NULL);</span>
01447    }
01448    buff = <a class="code" href="iddcm-restricted_8h.html#a1">_IdDcmReadElement</a>(gr, num, e);
01449    <span class="keywordflow">if</span> (buff == 0) {
01450       caster = malloc(4);
01451       sprintf(caster, <span class="stringliteral">"???"</span>);
01452       <span class="keywordflow">return</span> (caster);
01453    }
01454    <span class="keywordflow">if</span> ( (strcmp(vr,<span class="stringliteral">"UL"</span>) != 0)
01455      &amp;&amp; (strcmp(vr,<span class="stringliteral">"US"</span>) != 0)
01456      &amp;&amp; (strcmp(vr,<span class="stringliteral">"SL"</span>) != 0)
01457           &amp;&amp; (strcmp(vr,<span class="stringliteral">"SS"</span>) != 0)
01458      &amp;&amp; (gr != 0x0028 || 
01459       ( num != 0x0005 &amp;&amp; num != 0x0200) ) ) { 
01460                         <span class="comment">// les champs de vr RET sont des caract</span>
01461                           <span class="comment">// sauf (28,5) et (28,200) Pixel Location</span>
01462       <span class="keywordflow">return</span>((<span class="keywordtype">void</span> *) strdup(buff));
01463    }
01464    <span class="keywordflow">if</span> ( (strcmp(vr, <span class="stringliteral">"US"</span>) == 0)
01465      || (strcmp(vr, <span class="stringliteral">"SS"</span>) == 0)
01466           || (gr == 0x0028 &amp;&amp; 
01467       (num == 0x0005  || num == 0x0200) ) ) {   <span class="comment">// les champs de vr RET sont des caract</span>
01468                                        <span class="comment">// sauf (28,5) et (28,200) Pixel Location</span>
01469       <span class="comment">// Buff should contain an int16</span>
01470       caster = var_itoa(buff, 2);
01471       <span class="keywordflow">return</span>(caster);
01472    }
01473         <span class="keywordflow">if</span> ( (strcmp(vr,<span class="stringliteral">"UL"</span>) == 0)
01474           || (strcmp(vr,<span class="stringliteral">"SL"</span>) == 0) ) {
01475       <span class="comment">// Buff should contain a uint32_t</span>
01476       caster = var_itoa(buff, 2);
01477       <span class="keywordflow">return</span>(caster);
01478    }
01479    <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) printf(<span class="stringliteral">"impossible de passer ici, mais le compilo rale\n"</span>);
01480    <span class="keywordflow">return</span> (NULL);
01481 
01482 }
01483 
01484 
01485 <span class="comment">//</span>
01486 <span class="comment">/* ============================================================================= */</span>
01487 <span class="comment">//</span>
01488 
01489 
01490 
01491 <span class="comment">/* ----------------------------------------------------------------------- */</span>
01492 <span class="keyword">static</span> <span class="keywordtype">void</span> 
01493 _IdImprimerElement(<span class="keywordtype">char</span> **TableauImageInfo, <span class="keywordtype">int</span> numGroupe,
01494              <span class="keywordtype">int</span> numElem, <span class="keywordtype">char</span> *nomElem, <span class="keywordtype">int</span> position)
01495 {
01496    <span class="keywordflow">if</span> (!TableauImageInfo[position])
01497       printf(<span class="stringliteral">"%d : %s \t(%04x,%04x)  pas trouve \n"</span>, position,
01498           nomElem, numGroupe, numElem);
01499    <span class="keywordflow">else</span>
01500       printf(<span class="stringliteral">"%d : %s \t(%04x,%04x)\t[%s]\n"</span>, position,
01501           nomElem, numGroupe, numElem,
01502           TableauImageInfo[position]);
01503 }
01504 
01505 <span class="comment">/* ----------------------------------------------------------------------- */</span>
01506 
01521 <span class="keywordtype">int</span>
<a name="l01522"></a><a class="code" href="iddcm_8h.html#a19">01522</a> <a class="code" href="iddcm_8h.html#a19">IdDcmPrintImageInfo</a>(<span class="keywordtype">char</span> **TableauImageInfo) {
01523 
01524 <span class="keywordtype">int</span> k;
01525 <a class="code" href="struct____dicom__info____.html">DICOM_INFO</a> *t;
01526 t = <a class="code" href="dicom_8c.html#a0">_ID_dicom_info</a>;
01527 
01528    <span class="keywordflow">if</span> (!TableauImageInfo) <span class="keywordflow">return</span>(0);
01529 
01530    <span class="keywordflow">for</span>(k=0;k&lt;<a class="code" href="idacr_8h.html#a115a71">_ID_Number_of_Items</a>;k++) {
01531       _IdImprimerElement(TableauImageInfo, t[k].dicom_group, 
01532                   t[k].dicom_elem, 
01533                      t[k].dicom_info_libelle, 
01534                   t[k].dicom_info_ind);
01535    }
01536    <span class="keywordflow">return</span> (1);
01537 }
01538 
01539 
01540 
01541 <span class="comment">/* ----------------------------------------------------------------------- */</span>
01542 <span class="keyword">static</span> <span class="keywordtype">char</span> * _cleanString(<span class="keywordtype">char</span> *v) {
01543    
01544    <span class="keywordtype">char</span> *<a class="code" href="jerror_8h.html#a52a25">d</a>;
01545    <span class="keywordtype">int</span> i, l;
01546    l = strlen(v);
01547    <span class="keywordflow">for</span> ( i=0,<a class="code" href="jerror_8h.html#a52a25">d</a>=v; 
01548       i&lt;l ; 
01549       i++,<a class="code" href="jerror_8h.html#a52a25">d</a>++) 
01550       {
01551       <span class="keywordflow">if</span> (!isprint(*d))
01552          *<a class="code" href="jerror_8h.html#a52a25">d</a> = <span class="charliteral">'.'</span>;
01553    }
01554    
01555    <span class="keywordflow">return</span> v;
01556 }
01557 <span class="comment">/* ----------------------------------------------------------------------- */</span>
01558 
01559 
<a name="l01560"></a><a class="code" href="iddcm_8h.html#a20">01560</a> <span class="keywordtype">void</span> <a class="code" href="iddcm_8h.html#a20">IdDcmAffDcmHdr</a>(<a class="code" href="structID__DCM__HDR.html">ID_DCM_HDR</a> *e, <span class="keywordtype">int</span> npriv, <span class="keywordtype">int</span> noffset) {
01561 
01562 
01563 <a class="code" href="struct____Dicom____el____.html">DICOM_ELEMENTS</a> *t = NULL;
01564 <a class="code" href="struct__elem.html">PLIST</a> pl;
01565 <a class="code" href="struct__elem.html">PLIST_ELEMENT</a> plelem; 
01566 <a class="code" href="struct__ID__DCM__ELEM.html">_ID_DCM_ELEM</a> *ple;
01567    
01568    pl=e-&gt;<a class="code" href="structID__DCM__HDR.html#o19">plist</a>;
01569    plelem = <a class="code" href="idliste_8h.html#a17">IdLstFirst</a>(pl);
01570 
01571    <span class="keywordflow">while</span> (plelem) {
01572    
01573       ple= <a class="code" href="idliste_8h.html#a22">IdLstPtrObj</a>(plelem);  <span class="comment">// le _ID_DCM_ELEM  pointé par le PLIST_ELEMENT</span>
01574 
01575       <span class="keywordflow">if</span> (ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o1">Num</a>==0) { 
01576          <span class="keywordflow">if</span>(!npriv) printf(<span class="stringliteral">"\n"</span>); 
01577        } <span class="keywordflow">else</span> { 
01578          <span class="keywordflow">for</span> (t=<a class="code" href="dicom_8c.html#a3">_ID_dicom_elements</a>; t-&gt;<a class="code" href="struct____Dicom____el____.html#o0">dicom_group</a>!=0xffff; t++) {
01579             <span class="keywordflow">if</span>( (t-&gt;<a class="code" href="struct____Dicom____el____.html#o0">dicom_group</a>==ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o0">Gr</a>) &amp;&amp; (t-&gt;<a class="code" href="struct____Dicom____el____.html#o1">dicom_elem</a>==ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o1">Num</a>) ) <span class="keywordflow">break</span>;
01580          }
01581                }
01582       <span class="keywordflow">if</span>(!(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o0">Gr</a>%2) || !npriv) {
01583 
01584          <span class="keywordflow">if</span> (noffset) 
01585             printf(<span class="stringliteral">" gr %04x  num %04x  long %d"</span>,
01586                 ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o0">Gr</a>, ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o1">Num</a>, ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o2">LgrLueElem</a>);
01587          <span class="keywordflow">else</span>
01588             printf(<span class="stringliteral">" gr %04x  num %04x  long %d  _offset %d x(%x) o(%o12)"</span>,
01589                   ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o0">Gr</a>, ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o1">Num</a>, ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o2">LgrLueElem</a>, ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o5">Offset</a>,ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o5">Offset</a>,ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o5">Offset</a> );
01590       }
01591 
01592       <span class="keywordflow">if</span> (ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o1">Num</a>!=0) { 
01593       
01594          <span class="keywordflow">if</span>(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o6">VR</a> == NULL) {
01595             <span class="keywordflow">if</span>(!(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o0">Gr</a>%2) || !npriv) printf(<span class="stringliteral">"\t%s\t%s\t\t"</span>,  
01596                      t-&gt;<a class="code" href="struct____Dicom____el____.html#o2">dicom_type</a>, t-&gt;<a class="code" href="struct____Dicom____el____.html#o4">dicom_libelle</a>);
01597             } <span class="keywordflow">else</span> {
01598             <span class="keywordflow">if</span>(!(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o0">Gr</a>%2) || !npriv) printf(<span class="stringliteral">"\t%s\t%s\t\t"</span>,  
01599                      ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o6">VR</a>, t-&gt;<a class="code" href="struct____Dicom____el____.html#o4">dicom_libelle</a>);            
01600             }
01601             
01602             <span class="keywordflow">if</span> ( (ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o0">Gr</a>==0x0002) &amp;&amp; (ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o1">Num</a>==0x0010) ) {
01603                <span class="keywordtype">char</span> * s = <a class="code" href="str_8c.html#a14">_IdStrShowTransfertSyntax</a>(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>);
01604                printf(<span class="stringliteral">" : [%s] "</span>,s);
01605             }
01606       } 
01607       
01608       <span class="keywordflow">if</span> (ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o1">Num</a>==0) {   
01609          <span class="keywordflow">if</span>(!(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o0">Gr</a>%2) || !npriv){
01610                printf(<span class="stringliteral">"   lgr du grp = %d\n   -------\n"</span>,
01611                   <a class="code" href="iddcm_8h.html#a0">str2num</a>(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>,<span class="keywordtype">int</span>) );
01612          }
01613       } <span class="keywordflow">else</span> { 
01614          <span class="keywordflow">switch</span> (ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o3">LgrElem</a>) { 
01615          
01616          <span class="keywordflow">case</span> 2:                 <span class="comment">// LGR = 2</span>
01617 
01618             <span class="keywordflow">if</span> (     (strcmp(t-&gt;<a class="code" href="struct____Dicom____el____.html#o2">dicom_type</a>, <span class="stringliteral">"US"</span>) == 0)
01619                  || (strcmp(t-&gt;<a class="code" href="struct____Dicom____el____.html#o2">dicom_type</a>, <span class="stringliteral">"SS"</span>) == 0) 
01620                        || (t-&gt;<a class="code" href="struct____Dicom____el____.html#o0">dicom_group</a> == 0x0028 
01621                        &amp;&amp; 
01622                         (  t-&gt;<a class="code" href="struct____Dicom____el____.html#o1">dicom_elem</a> == 0x0005  
01623                     || t-&gt;<a class="code" href="struct____Dicom____el____.html#o1">dicom_elem</a> == 0x0200) ) ) {
01624    
01625                   <span class="keywordflow">if</span>(!(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o0">Gr</a>%2) || !npriv) { 
01626                      printf(<span class="stringliteral">"\t  \t \t %d \tx(%04x)\n"</span>,
01627                         <a class="code" href="iddcm_8h.html#a0">str2num</a>(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>,<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span>),
01628                         <a class="code" href="iddcm_8h.html#a0">str2num</a>(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>,<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span>) );  
01629                   }
01630             } <span class="keywordflow">else</span> {
01631 
01632                <span class="keywordflow">if</span>(!(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o0">Gr</a>%2) || !npriv){ 
01633                   printf(<span class="stringliteral">"\t[%s]  \t %d \tx(%04x)\n"</span>, 
01634                      _cleanString(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>),
01635                      <a class="code" href="iddcm_8h.html#a0">str2num</a>(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>,<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span>), 
01636                      <a class="code" href="iddcm_8h.html#a0">str2num</a>(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>,<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span>));
01637                }
01638             }
01639             <span class="keywordflow">break</span>;      
01640       
01641          <span class="keywordflow">case</span> 4 :       <span class="comment">// LGR = 4</span>
01642  
01643                <span class="keywordflow">if</span> (   (strcmp(t-&gt;<a class="code" href="struct____Dicom____el____.html#o2">dicom_type</a>,<span class="stringliteral">"UL"</span>) == 0)
01644                       || (strcmp(t-&gt;<a class="code" href="struct____Dicom____el____.html#o2">dicom_type</a>,<span class="stringliteral">"SL"</span>) == 0) ) {
01645                   <span class="keywordflow">if</span>(!(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o0">Gr</a>%2) || !npriv) { 
01646                      printf(<span class="stringliteral">"\t  \t \t %d \tx(%08x)\n"</span>, 
01647                         <a class="code" href="iddcm_8h.html#a0">str2num</a>(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>,<span class="keywordtype">int</span>), 
01648                         <a class="code" href="iddcm_8h.html#a0">str2num</a>(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>,<span class="keywordtype">int</span>));
01649                   }  
01650             } <span class="keywordflow">else</span> {
01651                   <span class="keywordflow">if</span>  (strcmp(t-&gt;<a class="code" href="struct____Dicom____el____.html#o2">dicom_type</a>,<span class="stringliteral">"FL"</span>) == 0) {
01652                      <span class="keywordflow">if</span>(!(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o0">Gr</a>%2) || !npriv) { 
01653                         printf(<span class="stringliteral">"\t  \t \t %f\t\n"</span>, 
01654                            <a class="code" href="iddcm_8h.html#a0">str2num</a>(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>,<span class="keywordtype">float</span>));                   
01655                      }
01656                   } <span class="keywordflow">else</span> {
01657                         <span class="keywordflow">if</span>(!(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o0">Gr</a>%2) || !npriv) { 
01658                            printf(<span class="stringliteral">" \t[%s]\n"</span>,_cleanString(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>));
01659                         }
01660                   }
01661             }
01662             <span class="keywordflow">break</span>;
01663             
01664             
01665          <span class="keywordflow">case</span> 8 :    <span class="comment">// lgr = 8 (double)</span>
01666          
01667                <span class="keywordflow">if</span> (strcmp(t-&gt;<a class="code" href="struct____Dicom____el____.html#o2">dicom_type</a>,<span class="stringliteral">"FD"</span>) == 0) {
01668                   <span class="keywordflow">if</span>(!(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o0">Gr</a>%2) || !npriv) { 
01669                      printf(<span class="stringliteral">"\t  \t \t %g \t\n"</span>, 
01670                         <a class="code" href="iddcm_8h.html#a0">str2num</a>(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>,<span class="keywordtype">double</span>));
01671                   }  
01672             } <span class="keywordflow">else</span> { 
01673                      <span class="keywordflow">if</span>(!(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o0">Gr</a>%2) || !npriv) { 
01674                         printf(<span class="stringliteral">"\t[%s]\n"</span>,_cleanString(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>));
01675                      }
01676             }
01677             <span class="keywordflow">break</span>;            
01678                   
01679          
01680          <span class="keywordflow">default</span> :                        <span class="comment">// AUTRES LGR</span>
01681 
01682             <span class="keywordflow">if</span> (ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o3">LgrElem</a> &gt; 5000) { 
01683                <span class="keywordflow">if</span>(!(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o0">Gr</a>%2) || !npriv) 
01684                   printf(<span class="stringliteral">" --&gt; Too Long (%08x). Not Printed...\n"</span>,ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o3">LgrElem</a>);
01685             } <span class="keywordflow">else</span> {
01686                <span class="keywordflow">if</span>(!(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o0">Gr</a>%2) || !npriv) 
01687                   printf(<span class="stringliteral">" \t[%s]\n"</span>,_cleanString(ple-&gt;<a class="code" href="struct__ID__DCM__ELEM.html#o9">valeurElem</a>));
01688             }
01689 
01690             }
01691       }
01692    plelem = <a class="code" href="idliste_8h.html#a20">IdLstNext</a>(plelem);
01693    }
01694 }
01695 
01696 <span class="comment">// -----------------------------------------------------------------------------------------------</span>
01697 
<a name="l01708"></a><a class="code" href="iddcm_8h.html#a9">01708</a> <a class="code" href="structID__DCM__HDR.html">ID_DCM_HDR</a> * <a class="code" href="iddcm_8h.html#a9">IdDcmIsDcmReadable</a>(<span class="keywordtype">char</span> * filename) {
01709 
01710 <span class="comment">// on suppose que la creation du DcmHeader est suffisante </span>
01711 <span class="comment">// pour que le fichier soit DcmReadble</span>
01712 <span class="comment">// (abusif, car un DICOMDIR permet de creer un DcmHeader</span>
01713 <span class="comment">// et n'est pas DcmReadable -pas de Pixels -...)</span>
01714 
01715    <a class="code" href="structID__DCM__HDR.html">ID_DCM_HDR</a> * a =<a class="code" href="iddcm_8h.html#a5">IdDcmGetHeader</a>(filename);
01716    <span class="keywordflow">return</span> a;
01717 }
01718 
01719 
01720 <span class="comment">// ----------------------------------------------------------------------------------------------</span>
01721  
01722  
<a name="l01733"></a><a class="code" href="iddcm_8h.html#a7">01733</a> <span class="keywordtype">int</span> <a class="code" href="iddcm_8h.html#a7">IdDcmIsJpegLossless</a> (<a class="code" href="structID__DCM__HDR.html">ID_DCM_HDR</a> * e) {
01734 <span class="keywordtype">char</span> * Derivation_Description;
01735 <span class="keywordtype">char</span> * Transfert_Syntax_UID;
01736 <span class="keywordtype">char</span> * valeur = <span class="stringliteral">"Compress BN JPEG Lossless"</span>;
01737 
01738    <span class="keywordflow">if</span> (!e) 
01739       <span class="keywordflow">return</span> (0);
01740       
01741    Transfert_Syntax_UID = <a class="code" href="iddcm-restricted_8h.html#a1">_IdDcmReadElement</a>(0x0002, 0x0010, e);
01742    <span class="keywordflow">if</span> (Transfert_Syntax_UID != NULL) {
01743       <span class="keywordflow">if</span> ( (memcmp(Transfert_Syntax_UID + strlen(Transfert_Syntax_UID)-2, <span class="stringliteral">"70"</span>, 2) == 0)
01744          ||
01745             (memcmp(Transfert_Syntax_UID + strlen(Transfert_Syntax_UID)-2, <span class="stringliteral">"55"</span>, 2) == 0) ) {
01746           <span class="keywordflow">return</span> (1);
01747        } <span class="keywordflow">else</span> {   
01748             Derivation_Description = <a class="code" href="iddcm-restricted_8h.html#a1">_IdDcmReadElement</a>(0x0008, 0x2111, e);
01749             <span class="keywordflow">if</span> (Derivation_Description != NULL) {
01750                <span class="keywordflow">if</span> (memcmp (Derivation_Description, valeur, strlen(valeur)) == 0)
01751                   <span class="keywordflow">return</span> (1);
01752             }  
01753       }
01754    }
01755    <span class="keywordflow">return</span> (0);
01756 }
01757 
01758 
01759 <span class="comment">// ----------------------------------------------------------------------------------------------</span>
01760  
01761  
<a name="l01773"></a><a class="code" href="iddcm_8h.html#a8">01773</a> <span class="keywordtype">int</span> <a class="code" href="iddcm_8h.html#a8">IdDcmIsUncompressed</a> (<a class="code" href="structID__DCM__HDR.html">ID_DCM_HDR</a> * e) {
01774 <span class="keywordtype">char</span> * Transfert_Syntax_UID;
01775 <span class="keywordtype">int</span> l;
01776 
01777    <span class="keywordflow">if</span> (!e) <span class="comment">// never allocated</span>
01778       <span class="keywordflow">return</span> (0);
01779       
01780    <span class="keywordflow">if</span> (!e-&gt;<a class="code" href="structID__DCM__HDR.html#o9">__TrueDicom</a>) <span class="comment">// old ACR-NEMA</span>
01781       <span class="keywordflow">return</span> (1);
01782       
01783    <span class="comment">// IsImplicitVRLittleEndianTransferSyntax         1.2.840.10008.1.2</span>
01784    <span class="comment">// IsExplicitVRLittleEndianTransferSyntax         1.2.840.10008.1.2.1</span>
01785    <span class="comment">// IsDeflatedExplicitVRLittleEndianTransferSyntax 1.2.840.10008.1.2.1.99</span>
01786    <span class="comment">// IsExplicitVRBigEndianTransferSyntax            1.2.840.10008.1.2.2</span>
01787       
01788    Transfert_Syntax_UID = <a class="code" href="iddcm-restricted_8h.html#a1">_IdDcmReadElement</a>(0x0002, 0x0010, e);
01789    
01790    <span class="keywordflow">if</span> (Transfert_Syntax_UID != NULL) {
01791       l = strlen(Transfert_Syntax_UID);
01792       <span class="keywordflow">if</span> ( (memcmp(Transfert_Syntax_UID,<span class="stringliteral">"1.2.840.10008.1.2"</span>,      l) == 0)
01793          ||
01794            (memcmp(Transfert_Syntax_UID,<span class="stringliteral">"1.2.840.10008.1.2.1"</span>,    l) == 0)
01795          ||
01796            (memcmp(Transfert_Syntax_UID,<span class="stringliteral">"1.2.840.10008.1.2.1.99"</span>, l) == 0)
01797          ||
01798            (memcmp(Transfert_Syntax_UID,<span class="stringliteral">"1.2.840.10008.1.2.2"</span>,    l) == 0)
01799                     
01800          )   
01801              <span class="keywordflow">return</span> (1);  <span class="comment">// uncompressed</span>
01802           <span class="keywordflow">else</span>
01803              <span class="keywordflow">return</span> (0);  <span class="comment">// others</span>
01804      } <span class="keywordflow">else</span> {
01805         <span class="keywordflow">return</span> (1); <span class="comment">// No Transfer Syntax found. Hope it's uncompressed</span>
01806      }   
01807 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Wed Dec 20 14:28:13 2006 for SIMRI3D by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
